import { supabase } from '../lib/supabaseClient';
import { Question, ReportContent } from '../../types';

/**
 * 从数据库获取自测题目 (category='self')
 */
export async function fetchQuestions(): Promise<Question[]> {
    const { data, error } = await supabase
        .from('questions')
        .select('*')
        .eq('category', 'self')  // 只获取自测题目
        .order('id', { ascending: true });

    if (error) {
        console.error('[API] fetchQuestions error:', error);
        throw error;
    }

    // 映射数据库字段到前端 Question 接口
    return (data || []).map((q: any) => ({
        id: q.id,
        text: q.text,
        options: q.options || [],
        values: q.values || [], // Attempt to fetch values if they exist
    }));
}

/**
 * 从数据库获取他测题目 (category='peer')
 */
export async function fetchPeerQuestions(): Promise<any[]> {
    const { data, error } = await supabase
        .from('questions')
        .select('*')
        .eq('category', 'peer')  // 只获取他测题目
        .order('id', { ascending: true });

    if (error) {
        console.error('[API] fetchPeerQuestions error:', error);
        throw error;
    }

    // 映射数据库字段到前端接口（他测题目使用 option_a/option_b）
    return (data || []).map((q: any) => ({
        id: q.id,
        text: q.text,
        option_a: q.option_a,
        option_b: q.option_b,
        value_a: q.value_a,
        value_b: q.value_b,
    }));
}

/**
 * 根据 MBTI 类型获取报告
 * @param mbtiType - 例如 'INTJ'
 */
export async function getReport(mbtiType: string): Promise<ReportContent | null> {
    const { data, error } = await supabase
        .from('personality_reports')
        .select('*')
        .eq('mbti_type', mbtiType.toUpperCase())
        .single();

    if (error) {
        console.error('[API] getReport error:', error);
        // 如果没找到对应类型，返回 null
        if (error.code === 'PGRST116') {
            return null;
        }
        throw error;
    }

    if (!data || !data.content) {
        return null;
    }

    const content = data.content;

    // ✅ 人格底色 fallback 查表（确保旧报告也显示正确文案）
    const baseColorLookup: Record<string, string> = {
        'ENFP': '你像一台会自我点燃的发动机：一旦看见"可能性"，整个人就活了。你擅长把零散的人和事连成一张网，让气氛、创意、机会在你周围流动。但你真正怕的不是失败，而是"被定死"和"无意义重复"。当你能把脑洞落到一个清晰的目标上，你会变成最可怕的推动者；当你没有抓手，你会用热闹来遮住空心。',
        'ENTP': '你不是爱抬杠，你是对"更优解"过敏。你看世界像看一张可重构的地图：规则可以改、框架可以拆、结论永远可以被升级。你最强的武器是思维弹性和洞察力，最容易被误解的点是：你看起来不在乎，其实你在乎的是"是否值得认真"。当你愿意长期投入，你能把一个想法打磨成体系；当你觉得不值，你会用玩笑迅速撤离。',
        'ESFP': '你不是肤浅，你是"活在现场"。你靠真实体验判断世界：好不好玩、舒不舒服、有没有火花，身体先知道。你天生会让场面变得有人味，让别人从紧绷里松下来。你最难忍的是被规则困住、被气氛冻住；你最强的成长路径是把"当下感"变成"稳定复利"：让你的天赋不只在一时，而是能持续变现。',
        'ESTP': '你属于"遇事先上手"的那类人：不靠想象推演，靠现场反馈校准。你在风险里反而冷静，因为你相信自己能处理变化。你擅长拆穿虚假、去掉废话、把事情推进到可落地的下一步。你真正的挑战不是冲动，而是耐心：当你学会在关键节点上多等一拍，你的效率会从"快"升级成"准"。',
        'INFJ': '你像一个安静的雷达，总能捕捉到"背后真正发生了什么"。你对人有深度共振能力，既能看见情绪，也能看见结构，所以你常常一边理解别人，一边悄悄承受。你不是不想行动，而是你对"意义"要求太高：不值得的事你做不了。你的人生课题是把洞察落地：给自己的理想配上时间表，别让"看得太透"变成"动不了"。',
        'INFP': '你活在一个很真实的内在世界里：感受、价值、信念对你来说比外界评价更重要。你不是脆弱，你是共振力太强——你能把别人的情绪当成自己的情绪体验。你最大的武器是纯粹：当你认定一件事有意义，你会异常坚定。你最大的消耗是自我怀疑：当现实不配合，你会以为是自己不够好。你的成长不是变强硬，而是建立边界，让善意不再透支你。',
        'ISFP': '你看世界的方式很细腻：你未必说很多，但你在"感受温度"。你尊重真实，不喜欢空话，也不喜欢被逼着表态。你最强的地方是审美与直觉——你知道什么让人舒服，什么让人窒息。你的难点在于：你常常把"不想争"误当成"无所谓"。当你学会用更清晰的方式表达自己的底线，你会从温柔变成有力量。',
        'ISTP': '你像一把多功能工具刀：安静、精准、讲效率。你不爱情绪拉扯，因为你更相信"解决问题"。你对世界的信任来自手感：拆开、看清、复原——你对复杂系统有天然亲和力。你容易被误解成冷淡，其实你只是情绪隔离做得好。你的人生升级点是：在关键关系里别只修机器，也修连接；让你的可靠不仅体现在事，也体现在人。',
        'ENFJ': '你天生知道怎样让一个群体"变得更像一个团队"。你能读懂情绪、掌控氛围、把人往同一个方向带，这是一种很稀缺的连接力与共振力。你的难点是：你太容易把别人的需求背在自己身上，甚至把"被需要"当成价值证明。你真正的强大来自选择：当你学会说"不"、学会把能量用在值得的人和事上，你会成为让别人变好的那种领导者。',
        'ENTJ': '你看世界像看项目：目标、资源、路径、结果。你不喜欢拖泥带水，因为你对时间的敏感度很高——你知道犹豫会吞噬成本。你最强的地方是把混乱变成结构，把幻想变成计划，把不可能变成执行。你的软肋不是不近人情，而是容易低估人的复杂性：当你把"人"也当成系统的一部分来理解，你的推进力会从强势升级为真正的统治力（温和但不可阻挡）。',
        'ESFJ': '你是"让生活顺起来"的那类人：人际关系、团队氛围、日常秩序，在你手里会变得可依靠。你对他人的感受很敏锐，愿意付出，也擅长照顾细节。你的挑战在于：你可能把"大家都好"当成自己的责任，久了会委屈、会憋。你的成长不是变得冷，而是更清晰：我可以善良，但我不牺牲；我可以照顾，但我有边界。',
        'ESTJ': '你是把事情做成的人：你相信规则、流程、负责到底。你对混乱的耐受度低，但这恰恰让你成为秩序的建立者——别人还在讨论，你已经在推进。你容易被误解成强硬，其实你只是把"可控"看得很重要。你的升级点是：在"对"之外，多给"人"一点空间。你不用变柔，你只要学会更聪明地使用力量。',
        'INTJ': '你像一名战略架构师：你不急着表达，因为你在内部跑模型。你擅长从复杂里抓主线，从噪音里找规律，然后做长期布局。你最强的地方是"自洽"：你有自己的逻辑、标准和节奏。你最容易卡住的地方是：想得太清楚，反而更挑剔现实；当现实达不到你的标准，你会宁可不开始。你的突破点是先动：让行动成为你的数据输入，而不是等完美再出发。',
        'INTP': '你像一个永远在更新的知识系统：你对"为什么"有天然执念，对漏洞、矛盾、逻辑断点极其敏感。你不爱被催，因为你的思考需要空间——你要的是准确，不是速度。你常被误解为冷漠，其实你只是把情绪放在后台。你的人生课题是把理解变成影响：当你学会用更易懂的方式输出结论，你会从"聪明的人"升级为"能改变世界的人"。',
        'ISFJ': '你是"把人照顾好、把日子过稳"的那类人：细节、记忆、承诺，对你来说不是负担，而是尊严。你不爱冒险，但你并不懦弱——你只是把风险算得很清楚。你最大的优点是可靠，最大的隐患是过度忍耐：你会把不舒服吞下去，直到突然耗尽。你的成长方向是把付出变得可持续：学会表达需求，学会让别人也为你负责。',
        'ISTJ': '你像一座秩序感很强的城市：规则明确、边界清楚、执行稳定。你相信"可验证的事实"，也相信"长期主义的努力"。你不爱花哨，但你会把每一步做扎实，所以你经常是那个真正撑住系统的人。你可能不擅长表达柔软，但你很擅长承担。你的升级点是：在稳定之外给自己一点弹性——不是为了变化而变化，而是为了让你更自由地使用你的可靠。',
    };
    const mbtiTypeFromDb = data.mbti_type?.toUpperCase() || '';
    const fallbackBaseColor = baseColorLookup[mbtiTypeFromDb] || '你拥有独特的人格特质，值得被深入了解和欣赏。';

    // ✅ keywords fallback 查表
    const keywordsLookup: Record<string, string[]> = {
        'ENFP': ['灵感喷泉', '气氛发动机', '热情理想派'],
        'ENTP': ['点子机器', '拆解大师', '逻辑玩家'],
        'ESFP': ['快乐制造机', '即刻满足派', '氛围担当'],
        'ESTP': ['实干派', '风险玩家', '现场王者'],
        'INFJ': ['深度共鸣者', '理想规划师', '隐形领袖'],
        'INFP': ['理想主义者', '情绪雷达', '温柔坚持派'],
        'ISFP': ['审美体质', '随性艺术派', '安静浪漫派'],
        'ISTP': ['问题终结者', '技术控', '独立玩家'],
        'ENFJ': ['天生领队', '情绪掌控者', '关系高手'],
        'ENTJ': ['决策机器', '目标导向派', '高效掌控者'],
        'ESFJ': ['氛围管家', '贴心担当', '稳定输出者'],
        'ESTJ': ['管理中枢', '规则守护者', '实务专家'],
        'INTJ': ['战略大脑', '长线布局者', '独立思考派'],
        'INTP': ['理论控', '深度拆解者', '思考成瘾者'],
        'ISFJ': ['细节管家', '安全感来源', '长期主义者'],
        'ISTJ': ['责任担当', '稳定输出派', '执行中枢'],
    };
    const fallbackKeywords = keywordsLookup[mbtiTypeFromDb] || ['独特个性', '深度洞察', '持续成长'];

    // 数据映射：后端 JSON -> 前端 ReportContent
    // ✅ title fallback
    const titleLookup: Record<string, string> = {
        'ENFP': '灵感连接者', 'ENTP': '思维破局者', 'ESFP': '现场体验官', 'ESTP': '行动突击手',
        'INFJ': '洞察引路人', 'INFP': '价值守护者', 'ISFP': '感性创作者', 'ISTP': '冷静工程师',
        'ENFJ': '人群引导者', 'ENTJ': '战略统帅者', 'ESFJ': '关系维护者', 'ESTJ': '秩序执行官',
        'INTJ': '系统设计师', 'INTP': '思维研究员', 'ISFJ': '稳定支撑者', 'ISTJ': '现实构建者',
    };
    const fallbackTitle = titleLookup[mbtiTypeFromDb] || '深度分析报告';

    const report: ReportContent = {
        type: data.mbti_type || mbtiType.toUpperCase(),
        title: fallbackTitle,
        keywords: content.keywords?.length ? content.keywords : fallbackKeywords,

        // 映射: 优先用数据库值，否则 fallback 到查表
        baseColor: content.cognitive_os?.text || fallbackBaseColor,

        // 映射: social_navigation -> social（lookup查表覆盖）
        social: (() => {
            const socialLookup: Record<string, { soulmate: string, partner: string, conflict: string }> = {
                'ENFP': { soulmate: 'ISTJ / INTJ', partner: 'INFP / ENFP', conflict: 'ESTJ / ISTJ' },
                'ENTP': { soulmate: 'ISFJ / INFJ', partner: 'INTP / ENTP', conflict: 'ESFJ / ISFJ' },
                'ESFP': { soulmate: 'INTJ / ISTJ', partner: 'ISFP / ESFP', conflict: 'INFJ / INTJ' },
                'ESTP': { soulmate: 'INFJ / ISFJ', partner: 'ISTP / ESTP', conflict: 'INFP / INFJ' },
                'INFP': { soulmate: 'ESTJ / ENTJ', partner: 'INFP / ENFP', conflict: 'ISTJ / ESTJ' },
                'INFJ': { soulmate: 'ESTP / ESFP', partner: 'INTJ / INFJ', conflict: 'ESTJ / ESTP' },
                'ISFP': { soulmate: 'ENTJ / ESTJ', partner: 'ISFP / ESFP', conflict: 'INTJ / ENTJ' },
                'ISTP': { soulmate: 'ENFJ / ESFJ', partner: 'ISTP / ESTP', conflict: 'INFP / ENFJ' },
                'ENFJ': { soulmate: 'ISTP / INTP', partner: 'ENFJ / INFJ', conflict: 'ESTP / ISTP' },
                'ENTJ': { soulmate: 'ISFP / INFP', partner: 'INTJ / ENTJ', conflict: 'ESFP / ISFP' },
                'ESFJ': { soulmate: 'INTP / ISTP', partner: 'ESFJ / ISFJ', conflict: 'ENTP / INTP' },
                'ESTJ': { soulmate: 'INFP / ISFP', partner: 'ESTJ / ISTJ', conflict: 'ENFP / INFP' },
                'INTJ': { soulmate: 'ESFP / ENFP', partner: 'INTJ / INFJ', conflict: 'ISFP / ESFP' },
                'INTP': { soulmate: 'ESFJ / ENFJ', partner: 'INTP / ENTP', conflict: 'ISFJ / ESFJ' },
                'ISFJ': { soulmate: 'ENTP / ESTP', partner: 'ISFJ / ESFJ', conflict: 'INFP / ENTP' },
                'ISTJ': { soulmate: 'ENFP / ESFP', partner: 'ISTJ / ESTJ', conflict: 'INFP / ENFP' },
            };
            const s = socialLookup[mbtiTypeFromDb] || { soulmate: '', partner: '', conflict: '' };
            return {
                soulmate: { type: s.soulmate, desc: '思路、优势与你不同，但能补你短板的人。' },
                partner: { type: s.partner, desc: '价值观、节奏与你接近，相处省力的人。' },
                conflict: { type: s.conflict, desc: '核心认知差异大，容易互相消耗的人。' },
            };
        })(),

        // ✅ 天赋 fallback
        talent: (() => {
            const talentLookup: Record<string, { strengths: string[], weaknesses: string[] }> = {
                'ENFP': { strengths: ['创意持续爆发力强', '人际连接能力出众', '情绪感染力很高'], weaknesses: ['容易频繁分心走神', '难以长期稳定坚持', '热情容易快速消退'] },
                'ENTP': { strengths: ['思维反应速度极快', '拆解复杂问题能力强', '创新点子持续不断'], weaknesses: ['执行力常常跟不上', '容易快速失去兴趣', '喜欢争辩抬杠'] },
                'ESFP': { strengths: ['气氛调节能力极强', '行动力非常直接果断', '现实感受非常敏锐'], weaknesses: ['冲动决策概率偏高', '长期规划能力较弱', '情绪容易波动'] },
                'ESTP': { strengths: ['实战解决能力突出', '抗压与适应力强', '决断速度非常快'], weaknesses: ['风险判断偏激进', '缺乏长期耐心', '容易鲁莽行事'] },
                'INFJ': { strengths: ['洞察人性能力极强', '深度共情能力突出', '长期战略意识强'], weaknesses: ['内心消耗极为严重', '情绪长期压抑隐藏', '容易过度理想化'] },
                'INFP': { strengths: ['核心价值感极稳定', '同理共情能力极强', '信念坚持度很高'], weaknesses: ['容易逃避现实压力', '情绪波动幅度较大', '行动启动能力弱'] },
                'ISFP': { strengths: ['审美与感受力突出', '对情绪变化敏感', '做事风格真实自然'], weaknesses: ['表达需求能力不足', '长期规划意识薄弱', '冲突时容易回避'] },
                'ISTP': { strengths: ['动手实操能力极强', '面对危机非常冷静', '快速解决问题'], weaknesses: ['情感表达明显不足', '对关系投入较低', '缺乏长线目标'] },
                'ENFJ': { strengths: ['群体领导感染力强', '协调关系能力突出', '鼓舞他人能力强'], weaknesses: ['容易过度消耗自己', '控制倾向较明显', '忽视自身需求'] },
                'ENTJ': { strengths: ['战略布局能力极强', '高效执行推进能力', '决策果断明确'], weaknesses: ['容易过度强势主导', '忽视他人情绪感受', '给人压迫感强'] },
                'ESFJ': { strengths: ['照顾他人能力突出', '责任感稳定可靠', '日常支持力强'], weaknesses: ['容易过度讨好他人', '回避正面冲突问题', '依赖外界认可'] },
                'ESTJ': { strengths: ['组织管理能力很强', '规则意识非常明确', '推进效率极高'], weaknesses: ['思维容易固化保守', '控制欲偏强明显', '对变化抗拒强'] },
                'INTJ': { strengths: ['系统性思维极强', '长线规划能力突出', '自我管理能力高'], weaknesses: ['情感表达较为冷淡', '对他人要求苛刻', '行动启动较慢'] },
                'INTP': { strengths: ['逻辑分析能力极强', '学习理解速度极快', '理论深度突出'], weaknesses: ['严重拖延执行任务', '容易脱离现实环境', '行动力明显不足'] },
                'ISFJ': { strengths: ['细节处理非常严谨', '忠诚稳定投入关系', '长期付出能力强'], weaknesses: ['长期压抑真实需求', '容易过度忍让退让', '对变化适应慢'] },
                'ISTJ': { strengths: ['执行力长期稳定', '责任意识非常强烈', '输出质量可靠'], weaknesses: ['思维模式较保守', '抗拒变化适应慢', '情绪表达压抑'] },
            };
            return talentLookup[mbtiTypeFromDb] || content.talent || { strengths: [], weaknesses: [] };
        })(),

        dimensions: (() => {
            const dims = content.dimensions || { decision: { title: '', content: '', limit: '' }, communication: { title: '', content: '', caution: '' }, work: { title: '', content: '', caution: '', careers: [] }, love: { title: '', content: '', partner: '' } };
            const decisionLookup: Record<string, { content: string, limit: string }> = {
                'ENFP': { content: '你在做决定时，几乎第一时间依赖内心的兴奋感、直觉共鸣和情绪反馈，只要觉得"有感觉""有潜力""好像会很有意思"，就会迅速投入。你会在脑中构建理想化画面，想象未来的可能性和快乐场景，却容易下意识忽略持续执行的难度、现实资源限制和长期压力。当热情消退后，你才发现自己背负了远超预期的责任，进而产生后悔、自责甚至逃避心理。', limit: '在任何让你异常兴奋的决定前，强制写下未来三个月可能遇到的最坏现实压力、时间成本和失败代价，确认你依然愿意承担，再继续行动。' },
                'ENTP': { content: '你习惯在脑中同时生成多个方案版本，不断拆解、重组、升级和优化，追求逻辑上最优的解决路径。你会反复推演各种可能走向，享受思考本身带来的智力快感，却容易因为"还能更好"而不断推翻旧方案。你常陷入准备过度、迟迟不落地的状态，把大量精力消耗在优化阶段，而不是执行阶段。', limit: '为每个重要决策设定明确的"冻结时间点"，超过这个节点无论满意与否都必须启动执行，否则你会永远停留在设计阶段。' },
                'ESFP': { content: '你做决定时高度依赖当下的情绪体验、现实感受和现场氛围，优先选择能让自己现在开心、放松、有参与感的选项。你对未来风险、隐性成本和长期结构关注较少，更倾向先享受过程，再处理后果。当现实压力出现时，容易产生"早知道就不选这个"的后悔心理。', limit: '所有涉及金钱、关系或职业走向的选择，至少给自己24小时冷却期，避免在情绪高点直接做出不可逆决定。' },
                'ESTP': { content: '你擅长迅速识别现实机会和可操作空间，一旦看到突破口，就会果断出手，相信自己能够边做边修、临场补救。你对风险有较高容忍度，习惯用行动换经验，却容易低估复杂系统中的连锁反应。当局势失控时，才意识到代价被严重低估。', limit: '在行动前必须完整评估三种最坏结局，并确认自己有现实能力承担，否则不要仅凭自信贸然下注。' },
                'INFJ': { content: '你在做决定前，会在内心反复推演未来走向、价值意义和对他人的影响，试图找到"既正确又不伤人"的平衡点。你习惯把长远后果、道德感受和人生方向一起纳入考量，因此思考周期很长。你容易因为担心选错而不断延迟行动，在犹豫中消耗大量心理能量。', limit: '在分析超过三次后强制启动行动机制，把剩余不确定性交给实践修正，而不是继续内耗。' },
                'INFP': { content: '你做决定时非常依赖内心价值感和真实感受，只有当选择与你的信念高度一致时，才会感到安心。你会反复审视"这是不是我想成为的人"，一旦觉得违心，就会本能抗拒现实条件。你容易在理想与生存之间长期拉扯，陷入情绪性犹豫。', limit: '先解决基本生存结构，再逐步向理想靠拢，否则理想会变成负担。' },
                'ISFP': { content: '你通常依据当下的感受、环境舒适度和心理安全感来判断选择，对外界压力高度敏感。你讨厌被催促或被逼迫表态，越被施压越容易回避决定。你更倾向顺势而行，而不是主动规划，长期容易错失关键节点。', limit: '用具体选项清单替代模糊感觉，逼自己面对真实选择空间。' },
                'ISTP': { content: '你做决定时优先评估现实条件、资源消耗和执行效率，习惯选择最省力、最稳妥的解决方案。你相信问题可以边做边修，但对长期结构缺乏耐心，容易陷入"先解决眼前再说"的循环模式。', limit: '在解决当下问题时，同时预留未来升级空间，避免反复返工。' },
                'ENFJ': { content: '你在做决定时，会本能地站在多方视角思考，优先考虑对他人的影响、关系稳定度和整体氛围。你习惯把"大家是否舒服""是否会失望"放在首位，而把自己的真实需求不断往后压。你往往在表面上显得果断，内心却长期为取舍而纠结，容易因为过度负责而产生隐形消耗。', limit: '在任何重要选择前，先单独写下你的真实需求，否则你的人生会逐渐变成集体项目。' },
                'ENTJ': { content: '你做决定时以目标达成和效率最大化为核心，会快速筛选路径、资源和执行方案，优先选择最短成功路线。你对拖延、模糊和反复讨论极度不耐烦，更愿意先推进再修正。但你容易忽视情绪成本和关系摩擦，后期才发现阻力来自人心而非能力。', limit: '在定方案前强制征求至少两个反对意见，避免陷入单向决策盲区。' },
                'ESFJ': { content: '你在做决定时高度关注环境反馈、群体期待和他人评价，倾向选择让大家安心、关系稳定的方案。你害怕因为选择而引发冲突或失衡，因此容易压抑个人偏好。长期下来，你可能在"为大家负责"的角色中逐渐迷失自我方向。', limit: '定期确认：这是你想要的人生，还是你替别人维护的秩序。' },
                'ESTJ': { content: '你习惯依据经验、规则、制度和既有成功路径判断问题，信任被验证过的方法。你追求清晰结构和可控流程，对混乱和试错容忍度低。面对未知领域时，你倾向回避风险，优先选择安全路线，容易错过潜在突破点。', limit: '为探索型决策设立低风险试验区，而不是直接全面否定新可能。' },
                'INTJ': { content: '你在做决定前，会在脑中构建完整的系统模型，反复推演未来走向、风险结构和资源配置方式，力求一次选对方向。你不喜欢边走边试，而更倾向充分准备后再行动。你容易因为追求最优路径而延迟启动，错过最佳时间窗口，同时也不愿轻易承认需要调整。', limit: '用最小可行方案先启动验证，再逐步优化系统，而不是等到完美才行动。' },
                'INTP': { content: '你做决定时不断补充信息、完善逻辑模型，试图构建绝对自洽的判断体系。你对信息缺失极度敏感，担心遗漏关键变量，导致决策失真。你容易陷入"再查一点"的循环，把犹豫合理化为理性，实则拖延。', limit: '提前设定信息收集上限，到点必须决策，否则思考会变成逃避。' },
                'ISFJ': { content: '你在判断选择时，会优先参考过往经验、责任义务和他人期待，倾向选择稳妥可靠、风险最低的路径。你害怕因为冒险破坏已有秩序，因此容易被惯性牵着走。长期下来，你可能忽视自身成长需求。', limit: '定期重新评估当前路径是否仍符合你的人生阶段，而不是只因为习惯继续坚持。' },
                'ISTJ': { content: '你依靠事实、流程和逻辑体系判断问题，追求高度确定性和可控性。你习惯按规则推进，避免模糊地带和高风险选择。面对不确定机会时，你往往选择保守方案，从而减少失败概率，也同时压缩了上升空间。', limit: '在关键节点允许一次可控试错，为未来积累突破可能性。' },
            };
            const d = decisionLookup[mbtiTypeFromDb];
            if (d) { dims.decision = { title: '决策路径', content: d.content, limit: d.limit }; }
            const commLookup: Record<string, { content: string, caution: string }> = {
                'ENFP': { content: '你在沟通中高度依赖情绪流动和当下共鸣，只要气氛好、感觉对，就会非常投入表达自己。你喜欢分享想法、感受和脑洞，希望通过交流建立连接感。但当对方反应冷淡或不回应时，你容易开始自我怀疑，甚至过度补偿式输出，反而让关系产生压力。', caution: '在表达前先判断对方是否有接收空间，而不是一味用热情填补沉默，否则容易消耗彼此。' },
                'ENTP': { content: '你在沟通中习惯不断抛出观点、假设和反向思考，把交流当成思维碰撞的过程。你享受辩论和讨论本身，却容易忽略对方的情绪承受度。很多时候你觉得是在交流思想，对方却觉得被挑战或否定。', caution: '在提出反驳前，先明确表达认同部分，再进入讨论，否则容易被误解为攻击型人格。' },
                'ESFP': { content: '你更偏好轻松、真实、有互动感的交流方式，擅长用情绪、氛围和行动拉近距离。你不喜欢过度分析或严肃对话，当话题变得沉重时容易回避。遇到冲突时，常用转移话题或冷处理代替正面沟通。', caution: '当问题已经影响关系时，主动面对一次不舒服的对话，比长期逃避更安全。' },
                'ESTP': { content: '你在沟通中直接、务实、目标导向，习惯快速切入重点解决问题。你不太关注对方的情绪铺垫，容易给人"太直""太冲"的感觉。你认为高效就是尊重，但对方可能觉得被忽视。', caution: '在给方案前先给共情，否则再正确的话也容易被拒绝。' },
                'INFJ': { content: '你在沟通中非常敏感，会下意识捕捉对方的情绪变化、潜台词和真实动机。你习惯先在心里反复消化，再选择是否表达，因此常给人"话不多但很深"的感觉。当关系重要时，你会投入大量情绪理解对方，但如果长期得不到回应，容易突然冷却甚至抽离。', caution: '重要关系中要适度表达真实想法，而不是长期靠猜测和忍耐维持，否则容易突然断联式疏远。' },
                'INFP': { content: '你在沟通中高度重视真实感和情感共鸣，希望被理解内心世界，而不仅是表面事实。你不擅长直接冲突，遇到不舒服时往往选择隐忍或回避。长期压抑后，容易突然情绪爆发，让对方措手不及。', caution: '当你开始反复内耗时，就该开口表达底线，否则委屈迟早会转化成关系破裂。' },
                'ISFP': { content: '你偏好温和、自然、不压迫的交流方式，更习惯用行动代替语言表达关心。你不喜欢被追问情绪，也不擅长解释内心逻辑。当对话变得紧张或复杂时，容易选择沉默或退场。', caution: '适当用语言说明你的真实感受，否则别人容易误以为你不在乎。' },
                'ISTP': { content: '你在沟通中偏理性、克制、简洁，习惯只说必要信息，不喜欢情绪化表达。你更关注"问题怎么解决"，而不是"情绪怎么安放"。这让你显得冷静可靠，但也容易被误解为冷漠疏离。', caution: '在解决问题前先回应情绪，否则你的理性容易变成关系隔阂。' },
                'ENFJ': { content: '你在沟通中高度关注关系走向和情绪氛围，会本能地照顾每个人的感受，努力让对话保持和谐顺畅。你擅长引导话题、缓解冲突，也习惯替别人承担情绪压力。但你往往隐藏自己的真实不满，长期压抑后容易突然情绪透支。', caution: '在关心别人之前先表达自己的真实需求，否则长期付出会变成隐形怨气。' },
                'ENTJ': { content: '你沟通时目标感极强，习惯直奔主题、快速定方向、推动结果。你重视效率和清晰度，对重复解释和情绪铺垫缺乏耐心。你往往觉得自己在"解决问题"，对方却觉得被压迫或忽视。', caution: '在下结论前先确认对方是否被理解，否则再正确也难被接受。' },
                'ESFJ': { content: '你非常在意互动中的礼貌度、舒适感和群体氛围，擅长照顾场面与关系稳定。你倾向顺应多数意见，避免冲突。但当你长期委屈自己时，会在私下产生强烈情绪波动。', caution: '不要为了维持表面和谐而长期压抑真实想法，否则关系迟早失衡。' },
                'ESTJ': { content: '你习惯以事实、规则和现实效率为核心表达观点，讲话直接明确，不喜欢模糊空间。你容易在无意中压制他人表达，让对方产生被否定感。', caution: '在强调规则前先倾听动机，否则容易被视为强势控制型。' },
                'INTJ': { content: '你在沟通中习惯先在脑中构建完整逻辑框架，再选择性输出结论，因此表达往往高度概括、跳跃性强。你不喜欢反复解释显而易见的逻辑，对低效讨论缺乏耐心。别人常觉得你冷静理性，你却觉得是在节省能量。', caution: '在给结论前补充推理过程，否则别人很难真正理解你的想法来源。' },
                'INTP': { content: '你习惯从概念、逻辑和系统结构出发进行交流，喜欢拆解问题本质。你容易在表达中不断补充细节、修正说法，导致重点模糊。你更关注"是否准确"，而不是"是否好懂"。', caution: '优先给结论，再补逻辑，否则对方容易在信息中迷路。' },
                'ISFJ': { content: '你在沟通中注重责任感、稳定感和情感安全，会主动照顾他人需求。你不擅长表达不满，往往选择默默承担。长期积累后，容易突然情绪爆发，让对方措手不及。', caution: '当你开始反复忍让时，就该及时表达边界，而不是继续消耗自己。' },
                'ISTJ': { content: '你以事实、流程和现实结果为核心展开交流，讲话务实严谨，逻辑清晰。你讨厌含糊和情绪化表达，更信任明确指令。对方容易觉得你冷硬或缺乏弹性。', caution: '在坚持原则时留出解释空间，否则容易被误解为不近人情。' },
            };
            const cm = commLookup[mbtiTypeFromDb];
            if (cm) { dims.communication = { title: '沟通模式', content: cm.content, caution: cm.caution }; }
            const workLookup: Record<string, { content: string, caution: string }> = {
                'ENFP': { content: '你在工作中高度依赖兴趣驱动和意义感，一旦觉得事情"有价值""有热情"，就会爆发出极强的投入度和创造力。你擅长发想法、拉资源、带气氛，但对重复执行、细节管理和长期坚持耐心不足。当工作逐渐变成流程化任务时，你容易倦怠、拖延甚至自我怀疑。', caution: '为每个项目设定阶段性成就点，把长期目标拆成短期兴奋源，否则你很容易半途失速。' },
                'ENTP': { content: '你在工作中思维活跃，擅长发现机会、优化结构、提出新方案，对创新和系统设计极有优势。你喜欢挑战旧模式，却容易频繁推翻自己原有计划，导致项目反复修改、迟迟难以收尾。你更享受构思阶段，而不是落地阶段。', caution: '给自己绑定强执行节点和外部监督机制，否则你的才华会停留在方案层。' },
                'ESFP': { content: '你在工作中重视参与感、互动感和情绪体验，适合需要现场反应、人际沟通和氛围带动的岗位。你对枯燥流程和长期规划耐受度低，容易因为情绪波动影响效率。环境不好时，状态下滑明显。', caution: '主动建立稳定作息和流程框架，否则情绪会直接决定你的产出水平。' },
                'ESTP': { content: '你行动力强，适应力高，擅长在复杂环境中快速解决问题，面对突发状况反应极快。你更偏向边做边学，对长期规划和系统建设关注较少。容易在后期留下结构性隐患。', caution: '在冲锋前预留复盘时间，否则你会不断重复补漏洞模式。' },
                'INFJ': { content: '你在工作中高度重视使命感、价值意义和长期影响，希望自己的付出"值得""有意义"。你擅长系统思考和深度洞察，但容易把标准定得过高，对自己要求极严。你往往默默承担额外责任，却不善于表达需求，长期容易心理透支。', caution: '学会为自己设定明确边界和优先级，否则你的责任感会被无限透支。' },
                'INFP': { content: '你在工作中非常重视价值认同和情感舒适度，只有在理念一致、被尊重的环境中才能发挥最大潜力。你对机械化任务和功利导向较为抗拒，容易因为违心工作而情绪低落。面对冲突时倾向回避。', caution: '先建立基本职业稳定性，再慢慢寻找理想空间，而不是频繁逃离现实。' },
                'ISFP': { content: '你偏好安静、自由、压力较低的工作环境，擅长专注完成具体任务。你不喜欢被严格监控或过度评价，情绪安全感直接影响效率。当外界干扰过多时，你容易退缩。', caution: '主动争取清晰任务边界和评价标准，避免长期处于模糊消耗状态。' },
                'ISTP': { content: '你逻辑清晰、动手能力强，擅长解决具体问题和技术难题。你更关注实际效果，对形式主义和无效会议极度反感。你不太热衷汇报成果，容易被低估价值。', caution: '刻意提升成果表达能力，否则你的专业容易被忽视。' },
                'ENFJ': { content: '你在工作中高度关注团队氛围、协作关系和成员状态，擅长调动积极性、整合资源、化解矛盾。你往往愿意多承担一些责任来换取整体稳定，对下属和同事投入大量情绪劳动。但你容易忽视自己的疲惫感，长期处在"照顾别人"的位置上，逐渐产生隐形透支。', caution: '明确哪些问题必须别人自己解决，否则你会被不断推向情绪保姆角色。' },
                'ENTJ': { content: '你目标感极强，习惯从结果出发倒推路径，对效率、执行力和责任意识要求很高。你擅长搭建体系、制定战略、推动团队前进，在混乱环境中反而更容易脱颖而出。但你有时过于强调速度和成果，容易忽略成员承受能力，导致隐性流失。', caution: '把"人是否跟得上"纳入绩效指标，否则体系迟早失血。' },
                'ESFJ': { content: '你重视秩序感、责任感和团队稳定度，擅长维持日常运转和服务体系。你对细节敏感，执行力强，愿意为团队默默付出。但你过于在意评价和认可，容易因为讨好型工作模式而被过度使用。', caution: '学会对额外任务说"不"，否则能力越强，负担越重。' },
                'ESTJ': { content: '你逻辑清晰、规则感强，擅长制定流程、监督执行和保障效率。你追求明确分工和可控结果，对混乱和拖延容忍度极低。你容易在无意中压制不同风格的成员，让团队创新受限。', caution: '给试错和探索留出缓冲空间，否则团队会逐渐僵化。' },
                'INTJ': { content: '你在工作中高度依赖系统思维和长期规划能力，习惯先构建完整框架，再逐步推进执行。你擅长战略设计、结构优化和复杂问题拆解，对低效流程和无意义重复极度反感。你往往独立承担核心思考任务，却不太愿意频繁汇报，容易被误解为疏离或不合群。', caution: '主动让成果可视化，用阶段性输出替代沉默积累，否则你的价值容易被低估。' },
                'INTP': { content: '你在工作中以逻辑严谨和问题拆解能力见长，喜欢研究系统原理和底层机制。你对知识深度要求极高，不满足于表面解决方案。你容易陷入过度思考和准备状态，对推进节奏把控较弱，导致机会流失。', caution: '设定强制交付节点，把思考转化为可验证成果，否则专业优势难以兑现。' },
                'ISFJ': { content: '你责任心强、执行稳定，擅长在复杂环境中维持秩序和流程连续性。你对细节和他人需求非常敏感，愿意承担额外事务换取团队稳定。但你容易长期被依赖，却缺乏上升空间。', caution: '学会区分"职责内贡献"和"情感付出"，避免被长期低价消耗。' },
                'ISTJ': { content: '你做事严谨务实，注重规则、标准和流程执行，对质量和稳定性要求极高。你擅长长期项目管理和风险控制，在稳定体系中表现突出。但你对变化和试错容忍度低，容易错过新机会。', caution: '在安全范围内主动尝试新路径，为未来发展预留弹性空间。' },
            };
            const wk = workLookup[mbtiTypeFromDb];
            const careersLookup: Record<string, string[]> = {
                'ENFP': ['品牌策划', '教育培训', '社群运营'],
                'ENTP': ['创业孵化', '产品设计', '商业分析'],
                'ESFP': ['内容表现', '活动统筹', '用户体验'],
                'ESTP': ['商务谈判', '风险应对', '市场拓展'],
                'INFP': ['内容创作', '心理支持', '项目策划'],
                'INFJ': ['战略研究', '教育咨询', '公共沟通'],
                'ISFP': ['视觉设计', '手作工艺', '美学策划'],
                'ISTP': ['技术研发', '系统维护', '质量检测'],
                'ENFJ': ['人才培养', '团队管理', '对外传播'],
                'ENTJ': ['战略管理', '投资决策', '组织运营'],
                'ESFJ': ['客户管理', '行政协调', '服务运营'],
                'ESTJ': ['项目统筹', '流程管理', '成本控制'],
                'INTJ': ['系统规划', '技术研究', '知识管理'],
                'INTP': ['理论研究', '逻辑建模', '数据分析'],
                'ISFJ': ['后勤支持', '档案管理', '风险排查'],
                'ISTJ': ['审计监察', '制度建设', '标准管理'],
            };
            if (wk) { dims.work = { ...dims.work, title: '工作风格', content: wk.content, caution: wk.caution, careers: careersLookup[mbtiTypeFromDb] || dims.work?.careers || [] }; }
            const loveLookup: Record<string, { content: string, partner: string }> = {
                'ENFP': { content: '你在恋爱中高度追求情感连接、精神共鸣和浪漫体验，一旦认定对方，就会非常投入、黏人、愿意付出。你喜欢分享情绪、梦想和生活细节，希望对方成为你的"灵魂伙伴"。但当关系趋于平淡或回应减少时，你容易开始焦虑、自我怀疑，甚至过度索取情绪确认，导致关系压力上升。', partner: '能听你天马行空聊天，也会帮你把想法变成现实的人。' },
                'ENTP': { content: '你在恋爱中喜欢思想碰撞、新鲜感和精神刺激，擅长制造话题和互动乐趣。你享受暧昧、探索和可能性阶段，但当关系进入稳定期后，容易感到乏味。你有时会无意中用"辩论""理性分析"处理情感问题，让对方觉得不被理解。', partner: '能接住你跳跃式表达，还会提醒你别跑太偏的人。' },
                'ESFP': { content: '你在恋爱中热情、直接、真诚，擅长用行动、陪伴和互动表达爱意。你重视当下体验和情绪共振，希望关系轻松快乐。但你不擅长处理长期规划和深层冲突，遇到压力时容易逃避或转移注意力。', partner: '愿意陪你玩闹，也会提醒你顾好生活细节的人。' },
                'ESTP': { content: '你在亲密关系中独立感强，行动导向明显，习惯用实际行为而非语言表达关心。你讨厌情绪拉扯和复杂沟通，希望问题快速解决。但你容易低估伴侣的情感需求，让对方觉得被忽视。', partner: '不限制你折腾尝试，还能在你出问题时兜底的人。' },
                'INFJ': { content: '你在恋爱中非常重视精神连接、价值共鸣和长期可能性，往往在投入前就已经在心里构建好"未来蓝图"。你愿意为关系付出理解、包容和情绪支持，但很少主动表达自己的委屈和不满。你习惯先忍、先让、先消化，直到情绪累积到极限，才突然冷却甚至抽离，让对方措手不及。', partner: '尊重你长期规划，也愿意一起面对现实压力的人。' },
                'INFP': { content: '你在亲密关系中高度追求真诚感、灵魂契合和情感安全感，希望被深度理解和珍惜。你容易理想化伴侣和关系，在前期投入大量情感期待。一旦现实与理想出现落差，你会陷入自我怀疑和情绪内耗，表面温和，内心却翻江倒海。', partner: '不嘲笑你敏感情绪，也不会逼你快速做决定的人。' },
                'ISFP': { content: '你在恋爱中温柔、体贴、重视陪伴，更习惯用行动而不是语言表达爱意。你不擅长情绪表达，也不喜欢冲突，当关系出现问题时，往往选择沉默或退让。你希望通过"少说话、多付出"维持稳定，却容易让真实需求被忽视。', partner: '不查你、不管你，又会在关键时刻站你这边的人。' },
                'ISTP': { content: '你在亲密关系中非常重视个人空间和自主感，不喜欢被情绪绑架或频繁追问内心状态。你更习惯用实际行动表达关心，而不是甜言蜜语。当伴侣情绪需求过多时，你容易本能退缩，让对方感觉被冷落。', partner: '不天天黏你，也不会对你忽冷忽热的人。' },
                'ENFJ': { content: '你在恋爱中极度重视伴侣感受和关系稳定度，习惯主动照顾情绪、安排生活、解决问题。你希望通过付出来换取安全感和被需要感，很容易在关系中扮演"情感支柱"。但你往往忽视自己的疲惫，当付出得不到对等回应时，内心失落却不愿明说。', partner: '看见你为别人操心，也会反过来照顾你的人。' },
                'ENTJ': { content: '你在亲密关系中目标感强，习惯规划未来、推动成长、解决现实问题，希望关系不断"升级"。你重视责任与承诺，但不太擅长细腻表达情绪。当你试图用管理思维经营爱情时，容易让伴侣感到压力和控制感。', partner: '不怕和你讨论分歧，也不会被你压着走的人。' },
                'ESFJ': { content: '你在恋爱中极度重视安全感、认可感和关系稳定性，愿意为伴侣投入大量时间与精力。你善于照顾细节，但对伴侣反馈高度敏感，容易因忽视而产生强烈不安。你往往通过付出来维系关系，却忽略自我边界。', partner: '珍惜你为家庭和关系付出的细节的人。' },
                'ESTJ': { content: '你在恋爱中务实、负责、行动导向，习惯用承担责任和解决问题证明爱意。你重视稳定和未来规划，但容易忽略情绪交流的重要性。当关系出现问题时，你倾向讲道理而非共情。', partner: '尊重你做事标准，也懂得安抚你情绪的人。' },
                'INTJ': { content: '你在亲密关系中极度理性克制，习惯先评估长期匹配度、价值观一致性和未来可行性，再决定是否深入投入。你表达爱意偏含蓄，更习惯用规划、承担责任和实际行动证明重视程度。但你不擅长情绪表达，容易让伴侣觉得被隔在内心世界之外。', partner: '愿意认真听你讲逻辑，不打断你思考节奏的人。' },
                'INTP': { content: '你在恋爱中重视思想交流和精神空间，希望伴侣理解你的独立性与探索欲。你不擅长处理复杂情绪，对黏人和情绪化需求容易产生逃避心理。当关系出现问题时，你倾向先分析原因，而不是先安抚感受。', partner: '包容你发散思考，还能帮你把事情收尾的人。' },
                'ISFJ': { content: '你在亲密关系中温柔、稳定、责任感强，习惯通过照顾生活细节、长期陪伴和默默付出来表达爱意。你不轻易表达不满，往往选择忍让换取和平。但长期压抑后容易突然情绪崩溃。', partner: '记得你的付出，也会主动回应你关心的人。' },
                'ISTJ': { content: '你在恋爱中务实、忠诚、重视承诺，更关注现实责任和长期稳定。你不擅长浪漫表达，习惯用守规则、履责任来证明爱意。你容易忽视情绪交流的重要性，让关系变得功能化。', partner: '尊重你做事方式，也愿意表达情绪的人。' },
            };
            const lv = loveLookup[mbtiTypeFromDb];
            if (lv) { dims.love = { title: '亲密关系', content: lv.content, partner: lv.partner }; }
            return dims;
        })(),

        // 关键修复：deviation 从数据库读取 + 用最新文案函数覆盖旧数据
        deviation: (() => {
            const perception = content.perception;
            const scripts = content.calibration_scripts;
            const dbDeviation = content.deviation; // submitPeerAssessment 写入的真实校准数据

            // 如果三者都不存在，返回 undefined
            if (!perception && !scripts && !dbDeviation) return undefined;

            // ✅ 覆盖 selfPerception
            const selfViewLookup: Record<string, string> = {
                'ENFP': '你觉得自己只是想让生活更有温度和连接感，喜欢分享想法、交流情绪、碰撞灵感，并不是为了博关注或刷存在感。',
                'ENTP': '你觉得自己只是爱思考、爱试错、爱推翻旧观点，希望不断接近更好的答案，并不是刻意唱反调。',
                'ESFP': '你觉得自己只是珍惜当下、重视体验，希望把生活过得真实快乐，而不是逃避规划。',
                'ESTP': '你觉得自己只是反应快、行动果断，习惯先解决问题再总结经验，并不是鲁莽行事。',
                'INFJ': '你觉得自己只是习惯提前思考意义与方向，希望做有价值的事，而不是想复杂化问题。',
                'INFP': '你觉得自己只是想忠于内心价值，不愿敷衍生活和关系，并不是脆弱敏感。',
                'ISFP': '你觉得自己只是想按舒服真实的方式生活，尊重感受和美感，并不是逃避责任。',
                'ISTP': '你觉得自己只是更相信逻辑和经验，习惯独立解决问题，并不是冷淡疏离。',
                'ENFJ': '你觉得自己只是希望身边的人和事情变得更好，愿意主动付出，并不是爱管闲事。',
                'ENTJ': '你觉得自己只是追求效率和成果，希望事情推进顺利，并不是想控制别人。',
                'ESFJ': '你觉得自己只是希望关系和环境稳定舒服，照顾大家情绪，并不是讨好型人格。',
                'ESTJ': '你觉得自己只是尊重规则和流程，希望事情靠谱推进，并不是死板保守。',
                'INTJ': '你觉得自己只是习惯做长期规划、降低风险，希望少走弯路，并不是高冷。',
                'INTP': '你觉得自己只是想把问题想透彻，不愿草率判断，并不是拖延逃避。',
                'ISFJ': '你觉得自己只是想把事情默默照顾好，不给别人添麻烦，并不是没主见。',
                'ISTJ': '你觉得自己只是重视责任与承诺，希望一切可控可靠，并不是顽固守旧。',
            };
            const selfPerception = selfViewLookup[mbtiTypeFromDb] || dbDeviation?.selfPerception || perception?.self_view || '';

            // ✅ 覆盖 othersPerception
            const peerViewLookup: Record<string, string> = {
                'ENFP': '在别人眼中，你展现出 ENFP 的热情外向特质，总是气氛担当、话题发动机，但也容易被误解为太情绪化或不够稳重。',
                'ENTP': '在别人看来，你带着 ENTP 的跳跃与犀利思维，总是点子不断、敢质疑权威，但有时会被觉得太爱辩论。',
                'ESFP': '在别人眼中，你呈现出 ESFP 的活力与感染力，总是爱玩爱笑、带动气氛，但容易被低估深度。',
                'ESTP': '在别人看来，你体现出 ESTP 的行动派特质，果敢直接、临场应变强，但有时被认为不够谨慎。',
                'INFJ': '在别人眼中，你带着 INFJ 的洞察与理想主义气质，显得深沉有想法，但也容易被觉得距离感强。',
                'INFP': '在别人看来，你呈现出 INFP 的细腻与理想感受力，温柔真诚，但也容易被理解为情绪化。',
                'ISFP': '在别人眼中，你带着 ISFP 的安静审美特质，温和随性，却常被低估主见与坚持。',
                'ISTP': '在别人看来，你体现出 ISTP 的冷静理性风格，低调务实，但容易显得不够热络。',
                'ENFJ': '在别人眼中，你呈现出 ENFJ 的领导与共情特质，温暖可靠，但有时会被觉得操心过多。',
                'ENTJ': '在别人看来，你展现出 ENTJ 的目标导向与执行力，强势果断，但容易给人压力感。',
                'ESFJ': '在别人眼中，你带着 ESFJ 的体贴与责任特质，可靠周到，但有时过于在意评价。',
                'ESTJ': '在别人看来，你体现出 ESTJ 的管理与执行能力，严谨高效，但容易显得强硬。',
                'INTJ': '在别人眼中，你呈现出 INTJ 的战略与独立思考特质，理性深沉，却常被误解为疏远。',
                'INTP': '在别人看来，你带着 INTP 的逻辑探索气质，思考深入，但容易显得游离现实。',
                'ISFJ': '在别人眼中，你呈现出 ISFJ 的稳定与奉献特质，值得信赖，却容易被忽视需求。',
                'ISTJ': '在别人看来，你体现出 ISTJ 的严谨与踏实特质，可靠稳重，但显得不够灵活。',
            };

            // ✅ 从多个来源提取 peerMBTI
            const originalOthersPerception = dbDeviation?.othersPerception
                || (typeof perception?.peer_view === 'string' ? perception.peer_view : perception?.peer_view?.desc)
                || perception?.othersPerception
                || '';
            const peerMBTI = perception?.peer_view?.type
                || (dbDeviation?.othersPerception?.match?.(/([A-Z]{4})/)?.[1])
                || '';
            const hasPeer = !!peerMBTI && !!originalOthersPerception;

            // othersPerception：有 peerMBTI 时用 lookup 覆盖
            const othersPerception = hasPeer
                ? (peerViewLookup[peerMBTI] || originalOthersPerception)
                : originalOthersPerception;

            return {
                // 1. 顶部两张卡片
                selfPerception,
                othersPerception,

                // 2. 核心共性 & 关键分歧（有 peerMBTI 时用最新函数重新生成）
                similarities: hasPeer ? getSimilarities(mbtiTypeFromDb, peerMBTI) : (dbDeviation?.similarities || scripts?.match?.short_desc || ''),
                differences: hasPeer ? getDifferences(mbtiTypeFromDb, peerMBTI) : (dbDeviation?.differences || scripts?.temperature?.short_desc || ''),

                // 3. 全维校准数据（保留数值，覆盖文案描述）
                dimensionAnalysis: hasPeer
                    ? (() => {
                        const freshAnalysis = calculateDimensionAnalysis(mbtiTypeFromDb, peerMBTI, content.self_scores);
                        const dbAnalysis = dbDeviation?.dimensionAnalysis || [];
                        // 用数据库的数值 + 最新的 desc
                        return freshAnalysis.map((fresh: any, i: number) => ({
                            ...fresh,
                            selfValue: dbAnalysis[i]?.selfValue ?? fresh.selfValue,
                            peerValue: dbAnalysis[i]?.peerValue ?? fresh.peerValue,
                        }));
                    })()
                    : (dbDeviation?.dimensionAnalysis || []),

                // 4. 底部大黑卡（有 peerMBTI 时用最新函数重新生成）
                conclusion: hasPeer
                    ? getCalibrationConclusion(mbtiTypeFromDb, peerMBTI, calculateDimensionAnalysis(mbtiTypeFromDb, peerMBTI, content.self_scores))
                    : (dbDeviation?.conclusion || {
                        archetype: scripts?.temperature?.title || '未定型',
                        desc: scripts?.temperature?.full_desc || '...',
                        suggestion: scripts?.temperature?.suggestion || '...',
                    }),
            };
        })(),

        // [关键修复] 显式构造 shareContent
        shareContent: {
            baseColor: (content.cognitive_os?.text || fallbackBaseColor).replace(/你/g, '我'),
            interactionGuide: (() => {
                const guideLookup: Record<string, string[]> = {
                    'ENFP': ['别用规则管死我，我会慢慢对你失去热情', '敷衍我想法，比直接拒绝更伤人', '别逼我稳定，我需要不断变化才有生命力'],
                    'ENTP': ['别把我讨论当攻击，我只是讨厌无脑结论', '一否定我，我立刻关闭沟通频道', '给我时间跑逻辑，催我只会更乱'],
                    'ESFP': ['别把关系搞得太严肃，我会想逃', '少教育我，多陪我体验生活', '你不参与我的世界，我也会慢慢抽离'],
                    'ESTP': ['拐弯抹角只会让我不耐烦', '拖太久的事，我会直接接管', '怀疑我能力，比吵架更致命'],
                    'INFJ': ['别强行撬开我内心，我会立刻关门', '不尊重我的信念，我会彻底疏远', '我安静时不是冷，是在自我修复'],
                    'INFP': ['别踩我的价值观，那是我的底线', '冷暴力会让我彻底心死', '没安全感，我一句真话都不会说'],
                    'ISFP': ['控制我生活，只会让我更沉默', '忽视我感受，我不会吵但会走远', '比较我和别人，是最快伤我的方式'],
                    'ISTP': ['情绪轰炸只会让我自动断联', '有问题不说清，我懒得猜', '粘太紧，我会直接后退'],
                    'ENFJ': ['别把我的付出当义务', '一直索取不回馈，我会耗光', '我照顾别人，也需要被照顾'],
                    'ENTJ': ['不守承诺，会直接降低你信用分', '情绪化沟通，只会让我失去耐心', '三天两头改主意，我会放弃合作'],
                    'ESFJ': ['我的好不是理所当然', '冷处理等于慢性伤害我', '不表达感谢，我会慢慢收回热情'],
                    'ESTJ': ['敷衍规则，就是对我不尊重', '拖延等于浪费我的生命', '混乱环境，会让我暴躁'],
                    'INTJ': ['打断我思路，比吵架还烦', '质疑我专业，我会直接拉黑', '情绪失控，会让我彻底降权你'],
                    'INTP': ['催我做决定，只会拖更久', '不给思考空间，我会摆烂', '要我装正常，比工作还累'],
                    'ISFJ': ['忽视我的付出，我会心寒', '一直忍不说，不代表没情绪', '不稳定回应，会慢慢击垮我'],
                    'ISTJ': ['不守时就是不尊重我', '随意改计划让我很焦虑', '含糊沟通等于浪费时间'],
                };
                return guideLookup[mbtiTypeFromDb] || content.shareContent?.interactionGuide || [];
            })()
        },


    };

    return report;
}

/**
 * 提交测试结果
 */
export async function createReport(answers: { questionId: number, value: string }[], accessCode?: string): Promise<any> {
    try {


        // 1. 算分逻辑
        const scores: Record<string, number> = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
        answers.forEach((ans) => {
            const val = ans.value;
            if (scores[val] !== undefined) {
                scores[val]++;
            }
        });

        const dim1 = scores.E >= scores.I ? 'E' : 'I';
        const dim2 = scores.S >= scores.N ? 'S' : 'N';
        const dim3 = scores.T >= scores.F ? 'T' : 'F';
        const dim4 = scores.J >= scores.P ? 'J' : 'P';
        const mbtiType = `${dim1}${dim2}${dim3}${dim4}`;

        // ✅ 雷达图数据（固定值查表，按 MBTI 类型）
        // 顺序：连接 → 共振 → 想象 → 判断 → 稳定 → 行动
        const radarLookup: Record<string, number[]> = {
            // [连接力, 共振力, 想象力, 判断力, 稳定力, 行动力]
            'ENFP': [86, 88, 88, 52, 50, 84],
            'ENTP': [88, 50, 86, 82, 52, 86],
            'ESFP': [90, 84, 52, 50, 48, 88],
            'ESTP': [88, 48, 50, 84, 50, 90],
            'INFJ': [50, 88, 90, 54, 86, 52],
            'INFP': [52, 90, 88, 50, 52, 48],
            'ISFP': [54, 86, 52, 48, 50, 50],
            'ISTP': [52, 48, 50, 88, 52, 54],
            'ENFJ': [88, 88, 84, 54, 84, 86],
            'ENTJ': [86, 50, 82, 90, 88, 90],
            'ESFJ': [90, 86, 54, 52, 86, 84],
            'ESTJ': [88, 48, 52, 88, 90, 90],
            'INTJ': [50, 50, 90, 88, 88, 54],
            'INTP': [52, 48, 88, 86, 52, 50],
            'ISFJ': [54, 88, 52, 50, 90, 52],
            'ISTJ': [52, 48, 50, 90, 90, 54],
        };
        const radarValues = radarLookup[mbtiType] || [50, 50, 50, 50, 50, 50];
        const radarData = [
            { axis: '连接力', value: radarValues[0] },
            { axis: '共振力', value: radarValues[1] },
            { axis: '想象力', value: radarValues[2] },
            { axis: '判断力', value: radarValues[3] },
            { axis: '稳定力', value: radarValues[4] },
            { axis: '行动力', value: radarValues[5] },
        ];

        // ✅ 人格底色文案（按 MBTI 类型查表）
        const baseColorLookup: Record<string, string> = {
            'ENFP': '你像一台会自我点燃的发动机：一旦看见"可能性"，整个人就活了。你擅长把零散的人和事连成一张网，让气氛、创意、机会在你周围流动。但你真正怕的不是失败，而是"被定死"和"无意义重复"。当你能把脑洞落到一个清晰的目标上，你会变成最可怕的推动者；当你没有抓手，你会用热闹来遮住空心。',
            'ENTP': '你不是爱抬杠，你是对"更优解"过敏。你看世界像看一张可重构的地图：规则可以改、框架可以拆、结论永远可以被升级。你最强的武器是思维弹性和洞察力，最容易被误解的点是：你看起来不在乎，其实你在乎的是"是否值得认真"。当你愿意长期投入，你能把一个想法打磨成体系；当你觉得不值，你会用玩笑迅速撤离。',
            'ESFP': '你不是肤浅，你是"活在现场"。你靠真实体验判断世界：好不好玩、舒不舒服、有没有火花，身体先知道。你天生会让场面变得有人味，让别人从紧绷里松下来。你最难忍的是被规则困住、被气氛冻住；你最强的成长路径是把"当下感"变成"稳定复利"：让你的天赋不只在一时，而是能持续变现。',
            'ESTP': '你属于"遇事先上手"的那类人：不靠想象推演，靠现场反馈校准。你在风险里反而冷静，因为你相信自己能处理变化。你擅长拆穿虚假、去掉废话、把事情推进到可落地的下一步。你真正的挑战不是冲动，而是耐心：当你学会在关键节点上多等一拍，你的效率会从"快"升级成"准"。',
            'INFJ': '你像一个安静的雷达，总能捕捉到"背后真正发生了什么"。你对人有深度共振能力，既能看见情绪，也能看见结构，所以你常常一边理解别人，一边悄悄承受。你不是不想行动，而是你对"意义"要求太高：不值得的事你做不了。你的人生课题是把洞察落地：给自己的理想配上时间表，别让"看得太透"变成"动不了"。',
            'INFP': '你活在一个很真实的内在世界里：感受、价值、信念对你来说比外界评价更重要。你不是脆弱，你是共振力太强——你能把别人的情绪当成自己的情绪体验。你最大的武器是纯粹：当你认定一件事有意义，你会异常坚定。你最大的消耗是自我怀疑：当现实不配合，你会以为是自己不够好。你的成长不是变强硬，而是建立边界，让善意不再透支你。',
            'ISFP': '你看世界的方式很细腻：你未必说很多，但你在"感受温度"。你尊重真实，不喜欢空话，也不喜欢被逼着表态。你最强的地方是审美与直觉——你知道什么让人舒服，什么让人窒息。你的难点在于：你常常把"不想争"误当成"无所谓"。当你学会用更清晰的方式表达自己的底线，你会从温柔变成有力量。',
            'ISTP': '你像一把多功能工具刀：安静、精准、讲效率。你不爱情绪拉扯，因为你更相信"解决问题"。你对世界的信任来自手感：拆开、看清、复原——你对复杂系统有天然亲和力。你容易被误解成冷淡，其实你只是情绪隔离做得好。你的人生升级点是：在关键关系里别只修机器，也修连接；让你的可靠不仅体现在事，也体现在人。',
            'ENFJ': '你天生知道怎样让一个群体"变得更像一个团队"。你能读懂情绪、掌控氛围、把人往同一个方向带，这是一种很稀缺的连接力与共振力。你的难点是：你太容易把别人的需求背在自己身上，甚至把"被需要"当成价值证明。你真正的强大来自选择：当你学会说"不"、学会把能量用在值得的人和事上，你会成为让别人变好的那种领导者。',
            'ENTJ': '你看世界像看项目：目标、资源、路径、结果。你不喜欢拖泥带水，因为你对时间的敏感度很高——你知道犹豫会吞噬成本。你最强的地方是把混乱变成结构，把幻想变成计划，把不可能变成执行。你的软肋不是不近人情，而是容易低估人的复杂性：当你把"人"也当成系统的一部分来理解，你的推进力会从强势升级为真正的统治力（温和但不可阻挡）。',
            'ESFJ': '你是"让生活顺起来"的那类人：人际关系、团队氛围、日常秩序，在你手里会变得可依靠。你对他人的感受很敏锐，愿意付出，也擅长照顾细节。你的挑战在于：你可能把"大家都好"当成自己的责任，久了会委屈、会憋。你的成长不是变得冷，而是更清晰：我可以善良，但我不牺牲；我可以照顾，但我有边界。',
            'ESTJ': '你是把事情做成的人：你相信规则、流程、负责到底。你对混乱的耐受度低，但这恰恰让你成为秩序的建立者——别人还在讨论，你已经在推进。你容易被误解成强硬，其实你只是把"可控"看得很重要。你的升级点是：在"对"之外，多给"人"一点空间。你不用变柔，你只要学会更聪明地使用力量。',
            'INTJ': '你像一名战略架构师：你不急着表达，因为你在内部跑模型。你擅长从复杂里抓主线，从噪音里找规律，然后做长期布局。你最强的地方是"自洽"：你有自己的逻辑、标准和节奏。你最容易卡住的地方是：想得太清楚，反而更挑剔现实；当现实达不到你的标准，你会宁可不开始。你的突破点是先动：让行动成为你的数据输入，而不是等完美再出发。',
            'INTP': '你像一个永远在更新的知识系统：你对"为什么"有天然执念，对漏洞、矛盾、逻辑断点极其敏感。你不爱被催，因为你的思考需要空间——你要的是准确，不是速度。你常被误解为冷漠，其实你只是把情绪放在后台。你的人生课题是把理解变成影响：当你学会用更易懂的方式输出结论，你会从"聪明的人"升级为"能改变世界的人"。',
            'ISFJ': '你是"把人照顾好、把日子过稳"的那类人：细节、记忆、承诺，对你来说不是负担，而是尊严。你不爱冒险，但你并不懦弱——你只是把风险算得很清楚。你最大的优点是可靠，最大的隐患是过度忍耐：你会把不舒服吞下去，直到突然耗尽。你的成长方向是把付出变得可持续：学会表达需求，学会让别人也为你负责。',
            'ISTJ': '你像一座秩序感很强的城市：规则明确、边界清楚、执行稳定。你相信"可验证的事实"，也相信"长期主义的努力"。你不爱花哨，但你会把每一步做扎实，所以你经常是那个真正撑住系统的人。你可能不擅长表达柔软，但你很擅长承担。你的升级点是：在稳定之外给自己一点弹性——不是为了变化而变化，而是为了让你更自由地使用你的可靠。',
        };
        const baseColorText = baseColorLookup[mbtiType] || '你拥有独特的人格特质，值得被深入了解和欣赏。';

        // ✅ 关键词/TAG（按 MBTI 类型查表）
        const keywordsLookup: Record<string, string[]> = {
            'ENFP': ['灵感喷泉', '气氛发动机', '热情理想派'],
            'ENTP': ['点子机器', '拆解大师', '逻辑玩家'],
            'ESFP': ['快乐制造机', '即刻满足派', '氛围担当'],
            'ESTP': ['实干派', '风险玩家', '现场王者'],
            'INFJ': ['深度共鸣者', '理想规划师', '隐形领袖'],
            'INFP': ['理想主义者', '情绪雷达', '温柔坚持派'],
            'ISFP': ['审美体质', '随性艺术派', '安静浪漫派'],
            'ISTP': ['问题终结者', '技术控', '独立玩家'],
            'ENFJ': ['天生领队', '情绪掌控者', '关系高手'],
            'ENTJ': ['决策机器', '目标导向派', '高效掌控者'],
            'ESFJ': ['氛围管家', '贴心担当', '稳定输出者'],
            'ESTJ': ['管理中枢', '规则守护者', '实务专家'],
            'INTJ': ['战略大脑', '长线布局者', '独立思考派'],
            'INTP': ['理论控', '深度拆解者', '思考成瘾者'],
            'ISFJ': ['细节管家', '安全感来源', '长期主义者'],
            'ISTJ': ['责任担当', '稳定输出派', '执行中枢'],
        };
        const mbtiKeywords = keywordsLookup[mbtiType] || ['独特个性', '深度洞察', '持续成长'];

        // ✅ 中文人格定位（按 MBTI 类型查表）
        const titleLookup: Record<string, string> = {
            'ENFP': '灵感连接者', 'ENTP': '思维破局者', 'ESFP': '现场体验官', 'ESTP': '行动突击手',
            'INFJ': '洞察引路人', 'INFP': '价值守护者', 'ISFP': '感性创作者', 'ISTP': '冷静工程师',
            'ENFJ': '人群引导者', 'ENTJ': '战略统帅者', 'ESFJ': '关系维护者', 'ESTJ': '秩序执行官',
            'INTJ': '系统设计师', 'INTP': '思维研究员', 'ISFJ': '稳定支撑者', 'ISTJ': '现实构建者',
        };
        const mbtiTitle = titleLookup[mbtiType] || '深度分析报告';

        // 2. 构造丰富内容 (Rich Content)
        const defaultContent = {
            title: mbtiTitle,
            keywords: mbtiKeywords,

            // ✅ 动态雷达图数据
            radarData: radarData,

            // ✅ 社交导航
            social_navigation: (() => {
                const socialLookup: Record<string, { soulmate: string, partner: string, conflict: string }> = {
                    'ENFP': { soulmate: 'ISTJ / INTJ', partner: 'INFP / ENFP', conflict: 'ESTJ / ISTJ' },
                    'ENTP': { soulmate: 'ISFJ / INFJ', partner: 'INTP / ENTP', conflict: 'ESFJ / ISFJ' },
                    'ESFP': { soulmate: 'INTJ / ISTJ', partner: 'ISFP / ESFP', conflict: 'INFJ / INTJ' },
                    'ESTP': { soulmate: 'INFJ / ISFJ', partner: 'ISTP / ESTP', conflict: 'INFP / INFJ' },
                    'INFP': { soulmate: 'ESTJ / ENTJ', partner: 'INFP / ENFP', conflict: 'ISTJ / ESTJ' },
                    'INFJ': { soulmate: 'ESTP / ESFP', partner: 'INTJ / INFJ', conflict: 'ESTJ / ESTP' },
                    'ISFP': { soulmate: 'ENTJ / ESTJ', partner: 'ISFP / ESFP', conflict: 'INTJ / ENTJ' },
                    'ISTP': { soulmate: 'ENFJ / ESFJ', partner: 'ISTP / ESTP', conflict: 'INFP / ENFJ' },
                    'ENFJ': { soulmate: 'ISTP / INTP', partner: 'ENFJ / INFJ', conflict: 'ESTP / ISTP' },
                    'ENTJ': { soulmate: 'ISFP / INFP', partner: 'INTJ / ENTJ', conflict: 'ESFP / ISFP' },
                    'ESFJ': { soulmate: 'INTP / ISTP', partner: 'ESFJ / ISFJ', conflict: 'ENTP / INTP' },
                    'ESTJ': { soulmate: 'INFP / ISFP', partner: 'ESTJ / ISTJ', conflict: 'ENFP / INFP' },
                    'INTJ': { soulmate: 'ESFP / ENFP', partner: 'INTJ / INFJ', conflict: 'ISFP / ESFP' },
                    'INTP': { soulmate: 'ESFJ / ENFJ', partner: 'INTP / ENTP', conflict: 'ISFJ / ESFJ' },
                    'ISFJ': { soulmate: 'ENTP / ESTP', partner: 'ISFJ / ESFJ', conflict: 'INFP / ENTP' },
                    'ISTJ': { soulmate: 'ENFP / ESFP', partner: 'ISTJ / ESTJ', conflict: 'INFP / ENFP' },
                };
                const s = socialLookup[mbtiType] || { soulmate: '', partner: '', conflict: '' };
                return {
                    soulmate: { type: s.soulmate, desc: '思路、优势与你不同，但能补你短板的人。' },
                    partner: { type: s.partner, desc: '价值观、节奏与你接近，相处省力的人。' },
                    conflict: { type: s.conflict, desc: '核心认知差异大，容易互相消耗的人。' }
                };
            })(),

            // ✅ 核心天赋
            talent: (() => {
                const talentLookup: Record<string, { strengths: string[], weaknesses: string[] }> = {
                    'ENFP': { strengths: ['创意持续爆发力强', '人际连接能力出众', '情绪感染力很高'], weaknesses: ['容易频繁分心走神', '难以长期稳定坚持', '热情容易快速消退'] },
                    'ENTP': { strengths: ['思维反应速度极快', '拆解复杂问题能力强', '创新点子持续不断'], weaknesses: ['执行力常常跟不上', '容易快速失去兴趣', '喜欢争辩抬杠'] },
                    'ESFP': { strengths: ['气氛调节能力极强', '行动力非常直接果断', '现实感受非常敏锐'], weaknesses: ['冲动决策概率偏高', '长期规划能力较弱', '情绪容易波动'] },
                    'ESTP': { strengths: ['实战解决能力突出', '抗压与适应力强', '决断速度非常快'], weaknesses: ['风险判断偏激进', '缺乏长期耐心', '容易鲁莽行事'] },
                    'INFJ': { strengths: ['洞察人性能力极强', '深度共情能力突出', '长期战略意识强'], weaknesses: ['内心消耗极为严重', '情绪长期压抑隐藏', '容易过度理想化'] },
                    'INFP': { strengths: ['核心价值感极稳定', '同理共情能力极强', '信念坚持度很高'], weaknesses: ['容易逃避现实压力', '情绪波动幅度较大', '行动启动能力弱'] },
                    'ISFP': { strengths: ['审美与感受力突出', '对情绪变化敏感', '做事风格真实自然'], weaknesses: ['表达需求能力不足', '长期规划意识薄弱', '冲突时容易回避'] },
                    'ISTP': { strengths: ['动手实操能力极强', '面对危机非常冷静', '快速解决问题'], weaknesses: ['情感表达明显不足', '对关系投入较低', '缺乏长线目标'] },
                    'ENFJ': { strengths: ['群体领导感染力强', '协调关系能力突出', '鼓舞他人能力强'], weaknesses: ['容易过度消耗自己', '控制倾向较明显', '忽视自身需求'] },
                    'ENTJ': { strengths: ['战略布局能力极强', '高效执行推进能力', '决策果断明确'], weaknesses: ['容易过度强势主导', '忽视他人情绪感受', '给人压迫感强'] },
                    'ESFJ': { strengths: ['照顾他人能力突出', '责任感稳定可靠', '日常支持力强'], weaknesses: ['容易过度讨好他人', '回避正面冲突问题', '依赖外界认可'] },
                    'ESTJ': { strengths: ['组织管理能力很强', '规则意识非常明确', '推进效率极高'], weaknesses: ['思维容易固化保守', '控制欲偏强明显', '对变化抗拒强'] },
                    'INTJ': { strengths: ['系统性思维极强', '长线规划能力突出', '自我管理能力高'], weaknesses: ['情感表达较为冷淡', '对他人要求苛刻', '行动启动较慢'] },
                    'INTP': { strengths: ['逻辑分析能力极强', '学习理解速度极快', '理论深度突出'], weaknesses: ['严重拖延执行任务', '容易脱离现实环境', '行动力明显不足'] },
                    'ISFJ': { strengths: ['细节处理非常严谨', '忠诚稳定投入关系', '长期付出能力强'], weaknesses: ['长期压抑真实需求', '容易过度忍让退让', '对变化适应慢'] },
                    'ISTJ': { strengths: ['执行力长期稳定', '责任意识非常强烈', '输出质量可靠'], weaknesses: ['思维模式较保守', '抗拒变化适应慢', '情绪表达压抑'] },
                };
                return talentLookup[mbtiType] || { strengths: ['独特个性优势', '深度洞察能力', '持续成长潜力'], weaknesses: ['待探索的边界', '成长中的挑战', '可优化的空间'] };
            })(),

            // ✅ 四大维度详情
            dimensions: {
                work: (() => {
                    const workLookup: Record<string, { content: string, caution: string }> = {
                        'ENFP': { content: '你在工作中高度依赖兴趣驱动和意义感，一旦觉得事情"有价值""有热情"，就会爆发出极强的投入度和创造力。你擅长发想法、拉资源、带气氛，但对重复执行、细节管理和长期坚持耐心不足。当工作逐渐变成流程化任务时，你容易倦怠、拖延甚至自我怀疑。', caution: '为每个项目设定阶段性成就点，把长期目标拆成短期兴奋源，否则你很容易半途失速。' },
                        'ENTP': { content: '你在工作中思维活跃，擅长发现机会、优化结构、提出新方案，对创新和系统设计极有优势。你喜欢挑战旧模式，却容易频繁推翻自己原有计划，导致项目反复修改、迟迟难以收尾。你更享受构思阶段，而不是落地阶段。', caution: '给自己绑定强执行节点和外部监督机制，否则你的才华会停留在方案层。' },
                        'ESFP': { content: '你在工作中重视参与感、互动感和情绪体验，适合需要现场反应、人际沟通和氛围带动的岗位。你对枯燥流程和长期规划耐受度低，容易因为情绪波动影响效率。环境不好时，状态下滑明显。', caution: '主动建立稳定作息和流程框架，否则情绪会直接决定你的产出水平。' },
                        'ESTP': { content: '你行动力强，适应力高，擅长在复杂环境中快速解决问题，面对突发状况反应极快。你更偏向边做边学，对长期规划和系统建设关注较少。容易在后期留下结构性隐患。', caution: '在冲锋前预留复盘时间，否则你会不断重复补漏洞模式。' },
                        'INFJ': { content: '你在工作中高度重视使命感、价值意义和长期影响，希望自己的付出"值得""有意义"。你擅长系统思考和深度洞察，但容易把标准定得过高，对自己要求极严。你往往默默承担额外责任，却不善于表达需求，长期容易心理透支。', caution: '学会为自己设定明确边界和优先级，否则你的责任感会被无限透支。' },
                        'INFP': { content: '你在工作中非常重视价值认同和情感舒适度，只有在理念一致、被尊重的环境中才能发挥最大潜力。你对机械化任务和功利导向较为抗拒，容易因为违心工作而情绪低落。面对冲突时倾向回避。', caution: '先建立基本职业稳定性，再慢慢寻找理想空间，而不是频繁逃离现实。' },
                        'ISFP': { content: '你偏好安静、自由、压力较低的工作环境，擅长专注完成具体任务。你不喜欢被严格监控或过度评价，情绪安全感直接影响效率。当外界干扰过多时，你容易退缩。', caution: '主动争取清晰任务边界和评价标准，避免长期处于模糊消耗状态。' },
                        'ISTP': { content: '你逻辑清晰、动手能力强，擅长解决具体问题和技术难题。你更关注实际效果，对形式主义和无效会议极度反感。你不太热衷汇报成果，容易被低估价值。', caution: '刻意提升成果表达能力，否则你的专业容易被忽视。' },
                        'ENFJ': { content: '你在工作中高度关注团队氛围、协作关系和成员状态，擅长调动积极性、整合资源、化解矛盾。你往往愿意多承担一些责任来换取整体稳定，对下属和同事投入大量情绪劳动。但你容易忽视自己的疲惫感，长期处在"照顾别人"的位置上，逐渐产生隐形透支。', caution: '明确哪些问题必须别人自己解决，否则你会被不断推向情绪保姆角色。' },
                        'ENTJ': { content: '你目标感极强，习惯从结果出发倒推路径，对效率、执行力和责任意识要求很高。你擅长搭建体系、制定战略、推动团队前进，在混乱环境中反而更容易脱颖而出。但你有时过于强调速度和成果，容易忽略成员承受能力，导致隐性流失。', caution: '把"人是否跟得上"纳入绩效指标，否则体系迟早失血。' },
                        'ESFJ': { content: '你重视秩序感、责任感和团队稳定度，擅长维持日常运转和服务体系。你对细节敏感，执行力强，愿意为团队默默付出。但你过于在意评价和认可，容易因为讨好型工作模式而被过度使用。', caution: '学会对额外任务说"不"，否则能力越强，负担越重。' },
                        'ESTJ': { content: '你逻辑清晰、规则感强，擅长制定流程、监督执行和保障效率。你追求明确分工和可控结果，对混乱和拖延容忍度极低。你容易在无意中压制不同风格的成员，让团队创新受限。', caution: '给试错和探索留出缓冲空间，否则团队会逐渐僵化。' },
                        'INTJ': { content: '你在工作中高度依赖系统思维和长期规划能力，习惯先构建完整框架，再逐步推进执行。你擅长战略设计、结构优化和复杂问题拆解，对低效流程和无意义重复极度反感。你往往独立承担核心思考任务，却不太愿意频繁汇报，容易被误解为疏离或不合群。', caution: '主动让成果可视化，用阶段性输出替代沉默积累，否则你的价值容易被低估。' },
                        'INTP': { content: '你在工作中以逻辑严谨和问题拆解能力见长，喜欢研究系统原理和底层机制。你对知识深度要求极高，不满足于表面解决方案。你容易陷入过度思考和准备状态，对推进节奏把控较弱，导致机会流失。', caution: '设定强制交付节点，把思考转化为可验证成果，否则专业优势难以兑现。' },
                        'ISFJ': { content: '你责任心强、执行稳定，擅长在复杂环境中维持秩序和流程连续性。你对细节和他人需求非常敏感，愿意承担额外事务换取团队稳定。但你容易长期被依赖，却缺乏上升空间。', caution: '学会区分"职责内贡献"和"情感付出"，避免被长期低价消耗。' },
                        'ISTJ': { content: '你做事严谨务实，注重规则、标准和流程执行，对质量和稳定性要求极高。你擅长长期项目管理和风险控制，在稳定体系中表现突出。但你对变化和试错容忍度低，容易错过新机会。', caution: '在安全范围内主动尝试新路径，为未来发展预留弹性空间。' },
                    };
                    const w = workLookup[mbtiType];
                    const careersLookup: Record<string, string[]> = {
                        'ENFP': ['品牌策划', '教育培训', '社群运营'],
                        'ENTP': ['创业孵化', '产品设计', '商业分析'],
                        'ESFP': ['内容表现', '活动统筹', '用户体验'],
                        'ESTP': ['商务谈判', '风险应对', '市场拓展'],
                        'INFP': ['内容创作', '心理支持', '项目策划'],
                        'INFJ': ['战略研究', '教育咨询', '公共沟通'],
                        'ISFP': ['视觉设计', '手作工艺', '美学策划'],
                        'ISTP': ['技术研发', '系统维护', '质量检测'],
                        'ENFJ': ['人才培养', '团队管理', '对外传播'],
                        'ENTJ': ['战略管理', '投资决策', '组织运营'],
                        'ESFJ': ['客户管理', '行政协调', '服务运营'],
                        'ESTJ': ['项目统筹', '流程管理', '成本控制'],
                        'INTJ': ['系统规划', '技术研究', '知识管理'],
                        'INTP': ['理论研究', '逻辑建模', '数据分析'],
                        'ISFJ': ['后勤支持', '档案管理', '风险排查'],
                        'ISTJ': ['审计监察', '制度建设', '标准管理'],
                    };
                    return { title: '工作风格', content: w?.content || '', careers: careersLookup[mbtiType] || ['品牌策划', '产品设计', '项目管理'], caution: w?.caution || '' };
                })(),
                love: (() => {
                    const loveLookup: Record<string, { content: string, partner: string }> = {
                        'ENFP': { content: '你在恋爱中高度追求情感连接、精神共鸣和浪漫体验，一旦认定对方，就会非常投入、黏人、愿意付出。你喜欢分享情绪、梦想和生活细节，希望对方成为你的"灵魂伙伴"。但当关系趋于平淡或回应减少时，你容易开始焦虑、自我怀疑，甚至过度索取情绪确认，导致关系压力上升。', partner: '能听你天马行空聊天，也会帮你把想法变成现实的人。' },
                        'ENTP': { content: '你在恋爱中喜欢思想碰撞、新鲜感和精神刺激，擅长制造话题和互动乐趣。你享受暧昧、探索和可能性阶段，但当关系进入稳定期后，容易感到乏味。你有时会无意中用"辩论""理性分析"处理情感问题，让对方觉得不被理解。', partner: '能接住你跳跃式表达，还会提醒你别跑太偏的人。' },
                        'ESFP': { content: '你在恋爱中热情、直接、真诚，擅长用行动、陪伴和互动表达爱意。你重视当下体验和情绪共振，希望关系轻松快乐。但你不擅长处理长期规划和深层冲突，遇到压力时容易逃避或转移注意力。', partner: '愿意陪你玩闹，也会提醒你顾好生活细节的人。' },
                        'ESTP': { content: '你在亲密关系中独立感强，行动导向明显，习惯用实际行为而非语言表达关心。你讨厌情绪拉扯和复杂沟通，希望问题快速解决。但你容易低估伴侣的情感需求，让对方觉得被忽视。', partner: '不限制你折腾尝试，还能在你出问题时兜底的人。' },
                        'INFJ': { content: '你在恋爱中非常重视精神连接、价值共鸣和长期可能性，往往在投入前就已经在心里构建好"未来蓝图"。你愿意为关系付出理解、包容和情绪支持，但很少主动表达自己的委屈和不满。你习惯先忍、先让、先消化，直到情绪累积到极限，才突然冷却甚至抽离，让对方措手不及。', partner: '尊重你长期规划，也愿意一起面对现实压力的人。' },
                        'INFP': { content: '你在亲密关系中高度追求真诚感、灵魂契合和情感安全感，希望被深度理解和珍惜。你容易理想化伴侣和关系，在前期投入大量情感期待。一旦现实与理想出现落差，你会陷入自我怀疑和情绪内耗，表面温和，内心却翻江倒海。', partner: '不嘲笑你敏感情绪，也不会逼你快速做决定的人。' },
                        'ISFP': { content: '你在恋爱中温柔、体贴、重视陪伴，更习惯用行动而不是语言表达爱意。你不擅长情绪表达，也不喜欢冲突，当关系出现问题时，往往选择沉默或退让。你希望通过"少说话、多付出"维持稳定，却容易让真实需求被忽视。', partner: '不查你、不管你，又会在关键时刻站你这边的人。' },
                        'ISTP': { content: '你在亲密关系中非常重视个人空间和自主感，不喜欢被情绪绑架或频繁追问内心状态。你更习惯用实际行动表达关心，而不是甜言蜜语。当伴侣情绪需求过多时，你容易本能退缩，让对方感觉被冷落。', partner: '不天天黏你，也不会对你忽冷忽热的人。' },
                        'ENFJ': { content: '你在恋爱中极度重视伴侣感受和关系稳定度，习惯主动照顾情绪、安排生活、解决问题。你希望通过付出来换取安全感和被需要感，很容易在关系中扮演"情感支柱"。但你往往忽视自己的疲惫，当付出得不到对等回应时，内心失落却不愿明说。', partner: '看见你为别人操心，也会反过来照顾你的人。' },
                        'ENTJ': { content: '你在亲密关系中目标感强，习惯规划未来、推动成长、解决现实问题，希望关系不断"升级"。你重视责任与承诺，但不太擅长细腻表达情绪。当你试图用管理思维经营爱情时，容易让伴侣感到压力和控制感。', partner: '不怕和你讨论分歧，也不会被你压着走的人。' },
                        'ESFJ': { content: '你在恋爱中极度重视安全感、认可感和关系稳定性，愿意为伴侣投入大量时间与精力。你善于照顾细节，但对伴侣反馈高度敏感，容易因忽视而产生强烈不安。你往往通过付出来维系关系，却忽略自我边界。', partner: '珍惜你为家庭和关系付出的细节的人。' },
                        'ESTJ': { content: '你在恋爱中务实、负责、行动导向，习惯用承担责任和解决问题证明爱意。你重视稳定和未来规划，但容易忽略情绪交流的重要性。当关系出现问题时，你倾向讲道理而非共情。', partner: '尊重你做事标准，也懂得安抚你情绪的人。' },
                        'INTJ': { content: '你在亲密关系中极度理性克制，习惯先评估长期匹配度、价值观一致性和未来可行性，再决定是否深入投入。你表达爱意偏含蓄，更习惯用规划、承担责任和实际行动证明重视程度。但你不擅长情绪表达，容易让伴侣觉得被隔在内心世界之外。', partner: '愿意认真听你讲逻辑，不打断你思考节奏的人。' },
                        'INTP': { content: '你在恋爱中重视思想交流和精神空间，希望伴侣理解你的独立性与探索欲。你不擅长处理复杂情绪，对黏人和情绪化需求容易产生逃避心理。当关系出现问题时，你倾向先分析原因，而不是先安抚感受。', partner: '包容你发散思考，还能帮你把事情收尾的人。' },
                        'ISFJ': { content: '你在亲密关系中温柔、稳定、责任感强，习惯通过照顾生活细节、长期陪伴和默默付出来表达爱意。你不轻易表达不满，往往选择忍让换取和平。但长期压抑后容易突然情绪崩溃。', partner: '记得你的付出，也会主动回应你关心的人。' },
                        'ISTJ': { content: '你在恋爱中务实、忠诚、重视承诺，更关注现实责任和长期稳定。你不擅长浪漫表达，习惯用守规则、履责任来证明爱意。你容易忽视情绪交流的重要性，让关系变得功能化。', partner: '尊重你做事方式，也愿意表达情绪的人。' },
                    };
                    const l = loveLookup[mbtiType];
                    return { title: '亲密关系', content: l?.content || '', partner: l?.partner || '' };
                })(),
                decision: (() => {
                    const decisionLookup: Record<string, { content: string, limit: string }> = {
                        'ENFP': { content: '你在做决定时，几乎第一时间依赖内心的兴奋感、直觉共鸣和情绪反馈，只要觉得"有感觉""有潜力""好像会很有意思"，就会迅速投入。你会在脑中构建理想化画面，想象未来的可能性和快乐场景，却容易下意识忽略持续执行的难度、现实资源限制和长期压力。当热情消退后，你才发现自己背负了远超预期的责任，进而产生后悔、自责甚至逃避心理。', limit: '在任何让你异常兴奋的决定前，强制写下未来三个月可能遇到的最坏现实压力、时间成本和失败代价，确认你依然愿意承担，再继续行动。' },
                        'ENTP': { content: '你习惯在脑中同时生成多个方案版本，不断拆解、重组、升级和优化，追求逻辑上最优的解决路径。你会反复推演各种可能走向，享受思考本身带来的智力快感，却容易因为"还能更好"而不断推翻旧方案。你常陷入准备过度、迟迟不落地的状态，把大量精力消耗在优化阶段，而不是执行阶段。', limit: '为每个重要决策设定明确的"冻结时间点"，超过这个节点无论满意与否都必须启动执行，否则你会永远停留在设计阶段。' },
                        'ESFP': { content: '你做决定时高度依赖当下的情绪体验、现实感受和现场氛围，优先选择能让自己现在开心、放松、有参与感的选项。你对未来风险、隐性成本和长期结构关注较少，更倾向先享受过程，再处理后果。当现实压力出现时，容易产生"早知道就不选这个"的后悔心理。', limit: '所有涉及金钱、关系或职业走向的选择，至少给自己24小时冷却期，避免在情绪高点直接做出不可逆决定。' },
                        'ESTP': { content: '你擅长迅速识别现实机会和可操作空间，一旦看到突破口，就会果断出手，相信自己能够边做边修、临场补救。你对风险有较高容忍度，习惯用行动换经验，却容易低估复杂系统中的连锁反应。当局势失控时，才意识到代价被严重低估。', limit: '在行动前必须完整评估三种最坏结局，并确认自己有现实能力承担，否则不要仅凭自信贸然下注。' },
                        'INFJ': { content: '你在做决定前，会在内心反复推演未来走向、价值意义和对他人的影响，试图找到"既正确又不伤人"的平衡点。你习惯把长远后果、道德感受和人生方向一起纳入考量，因此思考周期很长。你容易因为担心选错而不断延迟行动，在犹豫中消耗大量心理能量。', limit: '在分析超过三次后强制启动行动机制，把剩余不确定性交给实践修正，而不是继续内耗。' },
                        'INFP': { content: '你做决定时非常依赖内心价值感和真实感受，只有当选择与你的信念高度一致时，才会感到安心。你会反复审视"这是不是我想成为的人"，一旦觉得违心，就会本能抗拒现实条件。你容易在理想与生存之间长期拉扯，陷入情绪性犹豫。', limit: '先解决基本生存结构，再逐步向理想靠拢，否则理想会变成负担。' },
                        'ISFP': { content: '你通常依据当下的感受、环境舒适度和心理安全感来判断选择，对外界压力高度敏感。你讨厌被催促或被逼迫表态，越被施压越容易回避决定。你更倾向顺势而行，而不是主动规划，长期容易错失关键节点。', limit: '用具体选项清单替代模糊感觉，逼自己面对真实选择空间。' },
                        'ISTP': { content: '你做决定时优先评估现实条件、资源消耗和执行效率，习惯选择最省力、最稳妥的解决方案。你相信问题可以边做边修，但对长期结构缺乏耐心，容易陷入"先解决眼前再说"的循环模式。', limit: '在解决当下问题时，同时预留未来升级空间，避免反复返工。' },
                        'ENFJ': { content: '你在做决定时，会本能地站在多方视角思考，优先考虑对他人的影响、关系稳定度和整体氛围。你习惯把"大家是否舒服""是否会失望"放在首位，而把自己的真实需求不断往后压。你往往在表面上显得果断，内心却长期为取舍而纠结，容易因为过度负责而产生隐形消耗。', limit: '在任何重要选择前，先单独写下你的真实需求，否则你的人生会逐渐变成集体项目。' },
                        'ENTJ': { content: '你做决定时以目标达成和效率最大化为核心，会快速筛选路径、资源和执行方案，优先选择最短成功路线。你对拖延、模糊和反复讨论极度不耐烦，更愿意先推进再修正。但你容易忽视情绪成本和关系摩擦，后期才发现阻力来自人心而非能力。', limit: '在定方案前强制征求至少两个反对意见，避免陷入单向决策盲区。' },
                        'ESFJ': { content: '你在做决定时高度关注环境反馈、群体期待和他人评价，倾向选择让大家安心、关系稳定的方案。你害怕因为选择而引发冲突或失衡，因此容易压抑个人偏好。长期下来，你可能在"为大家负责"的角色中逐渐迷失自我方向。', limit: '定期确认：这是你想要的人生，还是你替别人维护的秩序。' },
                        'ESTJ': { content: '你习惯依据经验、规则、制度和既有成功路径判断问题，信任被验证过的方法。你追求清晰结构和可控流程，对混乱和试错容忍度低。面对未知领域时，你倾向回避风险，优先选择安全路线，容易错过潜在突破点。', limit: '为探索型决策设立低风险试验区，而不是直接全面否定新可能。' },
                        'INTJ': { content: '你在做决定前，会在脑中构建完整的系统模型，反复推演未来走向、风险结构和资源配置方式，力求一次选对方向。你不喜欢边走边试，而更倾向充分准备后再行动。你容易因为追求最优路径而延迟启动，错过最佳时间窗口，同时也不愿轻易承认需要调整。', limit: '用最小可行方案先启动验证，再逐步优化系统，而不是等到完美才行动。' },
                        'INTP': { content: '你做决定时不断补充信息、完善逻辑模型，试图构建绝对自洽的判断体系。你对信息缺失极度敏感，担心遗漏关键变量，导致决策失真。你容易陷入"再查一点"的循环，把犹豫合理化为理性，实则拖延。', limit: '提前设定信息收集上限，到点必须决策，否则思考会变成逃避。' },
                        'ISFJ': { content: '你在判断选择时，会优先参考过往经验、责任义务和他人期待，倾向选择稳妥可靠、风险最低的路径。你害怕因为冒险破坏已有秩序，因此容易被惯性牵着走。长期下来，你可能忽视自身成长需求。', limit: '定期重新评估当前路径是否仍符合你的人生阶段，而不是只因为习惯继续坚持。' },
                        'ISTJ': { content: '你依靠事实、流程和逻辑体系判断问题，追求高度确定性和可控性。你习惯按规则推进，避免模糊地带和高风险选择。面对不确定机会时，你往往选择保守方案，从而减少失败概率，也同时压缩了上升空间。', limit: '在关键节点允许一次可控试错，为未来积累突破可能性。' },
                    };
                    const d = decisionLookup[mbtiType];
                    return { title: '决策路径', content: d?.content || '', limit: d?.limit || '' };
                })(),
                communication: (() => {
                    const commLookup: Record<string, { content: string, caution: string }> = {
                        'ENFP': { content: '你在沟通中高度依赖情绪流动和当下共鸣，只要气氛好、感觉对，就会非常投入表达自己。你喜欢分享想法、感受和脑洞，希望通过交流建立连接感。但当对方反应冷淡或不回应时，你容易开始自我怀疑，甚至过度补偿式输出，反而让关系产生压力。', caution: '在表达前先判断对方是否有接收空间，而不是一味用热情填补沉默，否则容易消耗彼此。' },
                        'ENTP': { content: '你在沟通中习惯不断抛出观点、假设和反向思考，把交流当成思维碰撞的过程。你享受辩论和讨论本身，却容易忽略对方的情绪承受度。很多时候你觉得是在交流思想，对方却觉得被挑战或否定。', caution: '在提出反驳前，先明确表达认同部分，再进入讨论，否则容易被误解为攻击型人格。' },
                        'ESFP': { content: '你更偏好轻松、真实、有互动感的交流方式，擅长用情绪、氛围和行动拉近距离。你不喜欢过度分析或严肃对话，当话题变得沉重时容易回避。遇到冲突时，常用转移话题或冷处理代替正面沟通。', caution: '当问题已经影响关系时，主动面对一次不舒服的对话，比长期逃避更安全。' },
                        'ESTP': { content: '你在沟通中直接、务实、目标导向，习惯快速切入重点解决问题。你不太关注对方的情绪铺垫，容易给人"太直""太冲"的感觉。你认为高效就是尊重，但对方可能觉得被忽视。', caution: '在给方案前先给共情，否则再正确的话也容易被拒绝。' },
                        'INFJ': { content: '你在沟通中非常敏感，会下意识捕捉对方的情绪变化、潜台词和真实动机。你习惯先在心里反复消化，再选择是否表达，因此常给人"话不多但很深"的感觉。当关系重要时，你会投入大量情绪理解对方，但如果长期得不到回应，容易突然冷却甚至抽离。', caution: '重要关系中要适度表达真实想法，而不是长期靠猜测和忍耐维持，否则容易突然断联式疏远。' },
                        'INFP': { content: '你在沟通中高度重视真实感和情感共鸣，希望被理解内心世界，而不仅是表面事实。你不擅长直接冲突，遇到不舒服时往往选择隐忍或回避。长期压抑后，容易突然情绪爆发，让对方措手不及。', caution: '当你开始反复内耗时，就该开口表达底线，否则委屈迟早会转化成关系破裂。' },
                        'ISFP': { content: '你偏好温和、自然、不压迫的交流方式，更习惯用行动代替语言表达关心。你不喜欢被追问情绪，也不擅长解释内心逻辑。当对话变得紧张或复杂时，容易选择沉默或退场。', caution: '适当用语言说明你的真实感受，否则别人容易误以为你不在乎。' },
                        'ISTP': { content: '你在沟通中偏理性、克制、简洁，习惯只说必要信息，不喜欢情绪化表达。你更关注"问题怎么解决"，而不是"情绪怎么安放"。这让你显得冷静可靠，但也容易被误解为冷漠疏离。', caution: '在解决问题前先回应情绪，否则你的理性容易变成关系隔阂。' },
                        'ENFJ': { content: '你在沟通中高度关注关系走向和情绪氛围，会本能地照顾每个人的感受，努力让对话保持和谐顺畅。你擅长引导话题、缓解冲突，也习惯替别人承担情绪压力。但你往往隐藏自己的真实不满，长期压抑后容易突然情绪透支。', caution: '在关心别人之前先表达自己的真实需求，否则长期付出会变成隐形怨气。' },
                        'ENTJ': { content: '你沟通时目标感极强，习惯直奔主题、快速定方向、推动结果。你重视效率和清晰度，对重复解释和情绪铺垫缺乏耐心。你往往觉得自己在"解决问题"，对方却觉得被压迫或忽视。', caution: '在下结论前先确认对方是否被理解，否则再正确也难被接受。' },
                        'ESFJ': { content: '你非常在意互动中的礼貌度、舒适感和群体氛围，擅长照顾场面与关系稳定。你倾向顺应多数意见，避免冲突。但当你长期委屈自己时，会在私下产生强烈情绪波动。', caution: '不要为了维持表面和谐而长期压抑真实想法，否则关系迟早失衡。' },
                        'ESTJ': { content: '你习惯以事实、规则和现实效率为核心表达观点，讲话直接明确，不喜欢模糊空间。你容易在无意中压制他人表达，让对方产生被否定感。', caution: '在强调规则前先倾听动机，否则容易被视为强势控制型。' },
                        'INTJ': { content: '你在沟通中习惯先在脑中构建完整逻辑框架，再选择性输出结论，因此表达往往高度概括、跳跃性强。你不喜欢反复解释显而易见的逻辑，对低效讨论缺乏耐心。别人常觉得你冷静理性，你却觉得是在节省能量。', caution: '在给结论前补充推理过程，否则别人很难真正理解你的想法来源。' },
                        'INTP': { content: '你习惯从概念、逻辑和系统结构出发进行交流，喜欢拆解问题本质。你容易在表达中不断补充细节、修正说法，导致重点模糊。你更关注"是否准确"，而不是"是否好懂"。', caution: '优先给结论，再补逻辑，否则对方容易在信息中迷路。' },
                        'ISFJ': { content: '你在沟通中注重责任感、稳定感和情感安全，会主动照顾他人需求。你不擅长表达不满，往往选择默默承担。长期积累后，容易突然情绪爆发，让对方措手不及。', caution: '当你开始反复忍让时，就该及时表达边界，而不是继续消耗自己。' },
                        'ISTJ': { content: '你以事实、流程和现实结果为核心展开交流，讲话务实严谨，逻辑清晰。你讨厌含糊和情绪化表达，更信任明确指令。对方容易觉得你冷硬或缺乏弹性。', caution: '在坚持原则时留出解释空间，否则容易被误解为不近人情。' },
                    };
                    const c = commLookup[mbtiType];
                    return { title: '沟通模式', content: c?.content || '', caution: c?.caution || '' };
                })()
            },

            // ✅ 校准脚本 (填入真实文案)
            calibration_scripts: {
                temperature: {
                    title: "外冷内热指数",
                    short_desc: "你的外表是冰山，海面下藏着火焰。",
                    full_desc: "数据表明，你的自我评价偏向理性克制，但在亲密关系中，你其实有着非常细腻的情感需求。这种反差是你独特魅力的来源。",
                    suggestion: "尝试更主动地表达关心，让身边的人感受到你的温度。"
                },
                match: {
                    title: "知行合一度",
                    short_desc: "你的言行高度一致，值得信赖。",
                    full_desc: "无论是自我评价还是他人反馈，都显示你是一个'说到做到'的人。这种一致性是你赢得信任的基石。",
                    suggestion: "继续保持，这是你最宝贵的品质之一。"
                }
            },

            perception: {
                self_view: (() => {
                    const selfViewLookup: Record<string, string> = {
                        'ENFP': '你觉得自己只是想让生活更有温度和连接感，喜欢分享想法、交流情绪、碰撞灵感，并不是为了博关注或刷存在感。',
                        'ENTP': '你觉得自己只是爱思考、爱试错、爱推翻旧观点，希望不断接近更好的答案，并不是刻意唱反调。',
                        'ESFP': '你觉得自己只是珍惜当下、重视体验，希望把生活过得真实快乐，而不是逃避规划。',
                        'ESTP': '你觉得自己只是反应快、行动果断，习惯先解决问题再总结经验，并不是鲁莽行事。',
                        'INFJ': '你觉得自己只是习惯提前思考意义与方向，希望做有价值的事，而不是想复杂化问题。',
                        'INFP': '你觉得自己只是想忠于内心价值，不愿敷衍生活和关系，并不是脆弱敏感。',
                        'ISFP': '你觉得自己只是想按舒服真实的方式生活，尊重感受和美感，并不是逃避责任。',
                        'ISTP': '你觉得自己只是更相信逻辑和经验，习惯独立解决问题，并不是冷淡疏离。',
                        'ENFJ': '你觉得自己只是希望身边的人和事情变得更好，愿意主动付出，并不是爱管闲事。',
                        'ENTJ': '你觉得自己只是追求效率和成果，希望事情推进顺利，并不是想控制别人。',
                        'ESFJ': '你觉得自己只是希望关系和环境稳定舒服，照顾大家情绪，并不是讨好型人格。',
                        'ESTJ': '你觉得自己只是尊重规则和流程，希望事情靠谱推进，并不是死板保守。',
                        'INTJ': '你觉得自己只是习惯做长期规划、降低风险，希望少走弯路，并不是高冷。',
                        'INTP': '你觉得自己只是想把问题想透彻，不愿草率判断，并不是拖延逃避。',
                        'ISFJ': '你觉得自己只是想把事情默默照顾好，不给别人添麻烦，并不是没主见。',
                        'ISTJ': '你觉得自己只是重视责任与承诺，希望一切可控可靠，并不是顽固守旧。',
                    };
                    return selfViewLookup[mbtiType] || `在自我认知中，你展现了 ${mbtiType} 的典型特质。`;
                })(),
                peer_view: null // 👈 null 触发锁定状态
            },

            shareContent: {
                baseColor: baseColorText.replace(/你/g, '我'),
                interactionGuide: (() => {
                    const guideLookup: Record<string, string[]> = {
                        'ENFP': ['别用规则管死我，我会慢慢对你失去热情', '敷衍我想法，比直接拒绝更伤人', '别逼我稳定，我需要不断变化才有生命力'],
                        'ENTP': ['别把我讨论当攻击，我只是讨厌无脑结论', '一否定我，我立刻关闭沟通频道', '给我时间跑逻辑，催我只会更乱'],
                        'ESFP': ['别把关系搞得太严肃，我会想逃', '少教育我，多陪我体验生活', '你不参与我的世界，我也会慢慢抽离'],
                        'ESTP': ['拐弯抹角只会让我不耐烦', '拖太久的事，我会直接接管', '怀疑我能力，比吵架更致命'],
                        'INFJ': ['别强行撬开我内心，我会立刻关门', '不尊重我的信念，我会彻底疏远', '我安静时不是冷，是在自我修复'],
                        'INFP': ['别踩我的价值观，那是我的底线', '冷暴力会让我彻底心死', '没安全感，我一句真话都不会说'],
                        'ISFP': ['控制我生活，只会让我更沉默', '忽视我感受，我不会吵但会走远', '比较我和别人，是最快伤我的方式'],
                        'ISTP': ['情绪轰炸只会让我自动断联', '有问题不说清，我懒得猜', '粘太紧，我会直接后退'],
                        'ENFJ': ['别把我的付出当义务', '一直索取不回馈，我会耗光', '我照顾别人，也需要被照顾'],
                        'ENTJ': ['不守承诺，会直接降低你信用分', '情绪化沟通，只会让我失去耐心', '三天两头改主意，我会放弃合作'],
                        'ESFJ': ['我的好不是理所当然', '冷处理等于慢性伤害我', '不表达感谢，我会慢慢收回热情'],
                        'ESTJ': ['敷衍规则，就是对我不尊重', '拖延等于浪费我的生命', '混乱环境，会让我暴躁'],
                        'INTJ': ['打断我思路，比吵架还烦', '质疑我专业，我会直接拉黑', '情绪失控，会让我彻底降权你'],
                        'INTP': ['催我做决定，只会拖更久', '不给思考空间，我会摆烂', '要我装正常，比工作还累'],
                        'ISFJ': ['忽视我的付出，我会心寒', '一直忍不说，不代表没情绪', '不稳定回应，会慢慢击垮我'],
                        'ISTJ': ['不守时就是不尊重我', '随意改计划让我很焦虑', '含糊沟通等于浪费时间'],
                    };
                    return guideLookup[mbtiType] || ['真诚沟通', '互相尊重', '给予空间'];
                })()
            },
            cognitive_os: {
                title: "人格底色",
                text: baseColorText,
                process: [
                    { step: "输入", desc: "收集事实与数据" },
                    { step: "处理", desc: "逻辑分析与推导" },
                    { step: "输出", desc: "可执行的方案" }
                ]
            }
        };

        // 3. 写入数据库（包含 self_scores 供校准时使用）
        const { data, error } = await supabase
            .from('personality_reports')
            .insert([{ mbti_type: mbtiType, content: { ...defaultContent, self_scores: scores } }])
            .select()
            .single();

        if (error) throw error;

        // 将报告 ID 回写到 access_codes（如果有邀请码）
        if (accessCode && data?.id) {
            await supabase
                .from('access_codes')
                .update({ report_id: data.id })
                .eq('code', accessCode.trim().toUpperCase());
        }

        return data;

    } catch (err) {
        console.error("❌ [API] createReport 异常:", err);
        throw err;
    }
}

/**
 * 根据 ID 获取特定测试结果 (For /result/:id)
 */
export async function getReportById(id: string): Promise<ReportContent | null> {
    const { data, error } = await supabase
        .from('personality_reports')
        .select('*')
        .eq('id', id)
        .single();

    if (error) {
        console.error('[API] getReportById error:', error);
        return null;
    }

    if (!data || !data.content) return null;

    const content = data.content;

    // ✅ 人格底色 fallback 查表
    const baseColorLookup: Record<string, string> = {
        'ENFP': '你像一台会自我点燃的发动机：一旦看见"可能性"，整个人就活了。你擅长把零散的人和事连成一张网，让气氛、创意、机会在你周围流动。但你真正怕的不是失败，而是"被定死"和"无意义重复"。当你能把脑洞落到一个清晰的目标上，你会变成最可怕的推动者；当你没有抓手，你会用热闹来遮住空心。',
        'ENTP': '你不是爱抬杠，你是对"更优解"过敏。你看世界像看一张可重构的地图：规则可以改、框架可以拆、结论永远可以被升级。你最强的武器是思维弹性和洞察力，最容易被误解的点是：你看起来不在乎，其实你在乎的是"是否值得认真"。当你愿意长期投入，你能把一个想法打磨成体系；当你觉得不值，你会用玩笑迅速撤离。',
        'ESFP': '你不是肤浅，你是"活在现场"。你靠真实体验判断世界：好不好玩、舒不舒服、有没有火花，身体先知道。你天生会让场面变得有人味，让别人从紧绷里松下来。你最难忍的是被规则困住、被气氛冻住；你最强的成长路径是把"当下感"变成"稳定复利"：让你的天赋不只在一时，而是能持续变现。',
        'ESTP': '你属于"遇事先上手"的那类人：不靠想象推演，靠现场反馈校准。你在风险里反而冷静，因为你相信自己能处理变化。你擅长拆穿虚假、去掉废话、把事情推进到可落地的下一步。你真正的挑战不是冲动，而是耐心：当你学会在关键节点上多等一拍，你的效率会从"快"升级成"准"。',
        'INFJ': '你像一个安静的雷达，总能捕捉到"背后真正发生了什么"。你对人有深度共振能力，既能看见情绪，也能看见结构，所以你常常一边理解别人，一边悄悄承受。你不是不想行动，而是你对"意义"要求太高：不值得的事你做不了。你的人生课题是把洞察落地：给自己的理想配上时间表，别让"看得太透"变成"动不了"。',
        'INFP': '你活在一个很真实的内在世界里：感受、价值、信念对你来说比外界评价更重要。你不是脆弱，你是共振力太强——你能把别人的情绪当成自己的情绪体验。你最大的武器是纯粹：当你认定一件事有意义，你会异常坚定。你最大的消耗是自我怀疑：当现实不配合，你会以为是自己不够好。你的成长不是变强硬，而是建立边界，让善意不再透支你。',
        'ISFP': '你看世界的方式很细腻：你未必说很多，但你在"感受温度"。你尊重真实，不喜欢空话，也不喜欢被逼着表态。你最强的地方是审美与直觉——你知道什么让人舒服，什么让人窒息。你的难点在于：你常常把"不想争"误当成"无所谓"。当你学会用更清晰的方式表达自己的底线，你会从温柔变成有力量。',
        'ISTP': '你像一把多功能工具刀：安静、精准、讲效率。你不爱情绪拉扯，因为你更相信"解决问题"。你对世界的信任来自手感：拆开、看清、复原——你对复杂系统有天然亲和力。你容易被误解成冷淡，其实你只是情绪隔离做得好。你的人生升级点是：在关键关系里别只修机器，也修连接；让你的可靠不仅体现在事，也体现在人。',
        'ENFJ': '你天生知道怎样让一个群体"变得更像一个团队"。你能读懂情绪、掌控氛围、把人往同一个方向带，这是一种很稀缺的连接力与共振力。你的难点是：你太容易把别人的需求背在自己身上，甚至把"被需要"当成价值证明。你真正的强大来自选择：当你学会说"不"、学会把能量用在值得的人和事上，你会成为让别人变好的那种领导者。',
        'ENTJ': '你看世界像看项目：目标、资源、路径、结果。你不喜欢拖泥带水，因为你对时间的敏感度很高——你知道犹豫会吞噬成本。你最强的地方是把混乱变成结构，把幻想变成计划，把不可能变成执行。你的软肋不是不近人情，而是容易低估人的复杂性：当你把"人"也当成系统的一部分来理解，你的推进力会从强势升级为真正的统治力（温和但不可阻挡）。',
        'ESFJ': '你是"让生活顺起来"的那类人：人际关系、团队氛围、日常秩序，在你手里会变得可依靠。你对他人的感受很敏锐，愿意付出，也擅长照顾细节。你的挑战在于：你可能把"大家都好"当成自己的责任，久了会委屈、会憋。你的成长不是变得冷，而是更清晰：我可以善良，但我不牺牲；我可以照顾，但我有边界。',
        'ESTJ': '你是把事情做成的人：你相信规则、流程、负责到底。你对混乱的耐受度低，但这恰恰让你成为秩序的建立者——别人还在讨论，你已经在推进。你容易被误解成强硬，其实你只是把"可控"看得很重要。你的升级点是：在"对"之外，多给"人"一点空间。你不用变柔，你只要学会更聪明地使用力量。',
        'INTJ': '你像一名战略架构师：你不急着表达，因为你在内部跑模型。你擅长从复杂里抓主线，从噪音里找规律，然后做长期布局。你最强的地方是"自洽"：你有自己的逻辑、标准和节奏。你最容易卡住的地方是：想得太清楚，反而更挑剔现实；当现实达不到你的标准，你会宁可不开始。你的突破点是先动：让行动成为你的数据输入，而不是等完美再出发。',
        'INTP': '你像一个永远在更新的知识系统：你对"为什么"有天然执念，对漏洞、矛盾、逻辑断点极其敏感。你不爱被催，因为你的思考需要空间——你要的是准确，不是速度。你常被误解为冷漠，其实你只是把情绪放在后台。你的人生课题是把理解变成影响：当你学会用更易懂的方式输出结论，你会从"聪明的人"升级为"能改变世界的人"。',
        'ISFJ': '你是"把人照顾好、把日子过稳"的那类人：细节、记忆、承诺，对你来说不是负担，而是尊严。你不爱冒险，但你并不懦弱——你只是把风险算得很清楚。你最大的优点是可靠，最大的隐患是过度忍耐：你会把不舒服吞下去，直到突然耗尽。你的成长方向是把付出变得可持续：学会表达需求，学会让别人也为你负责。',
        'ISTJ': '你像一座秩序感很强的城市：规则明确、边界清楚、执行稳定。你相信"可验证的事实"，也相信"长期主义的努力"。你不爱花哨，但你会把每一步做扎实，所以你经常是那个真正撑住系统的人。你可能不擅长表达柔软，但你很擅长承担。你的升级点是：在稳定之外给自己一点弹性——不是为了变化而变化，而是为了让你更自由地使用你的可靠。',
    };
    const mbtiTypeFromDb = data.mbti_type?.toUpperCase() || '';
    const fallbackBaseColor = baseColorLookup[mbtiTypeFromDb] || '你拥有独特的人格特质，值得被深入了解和欣赏。';

    // ✅ keywords fallback 查表
    const keywordsLookup: Record<string, string[]> = {
        'ENFP': ['灵感喷泉', '气氛发动机', '热情理想派'],
        'ENTP': ['点子机器', '拆解大师', '逻辑玩家'],
        'ESFP': ['快乐制造机', '即刻满足派', '氛围担当'],
        'ESTP': ['实干派', '风险玩家', '现场王者'],
        'INFJ': ['深度共鸣者', '理想规划师', '隐形领袖'],
        'INFP': ['理想主义者', '情绪雷达', '温柔坚持派'],
        'ISFP': ['审美体质', '随性艺术派', '安静浪漫派'],
        'ISTP': ['问题终结者', '技术控', '独立玩家'],
        'ENFJ': ['天生领队', '情绪掌控者', '关系高手'],
        'ENTJ': ['决策机器', '目标导向派', '高效掌控者'],
        'ESFJ': ['氛围管家', '贴心担当', '稳定输出者'],
        'ESTJ': ['管理中枢', '规则守护者', '实务专家'],
        'INTJ': ['战略大脑', '长线布局者', '独立思考派'],
        'INTP': ['理论控', '深度拆解者', '思考成瘾者'],
        'ISFJ': ['细节管家', '安全感来源', '长期主义者'],
        'ISTJ': ['责任担当', '稳定输出派', '执行中枢'],
    };
    const fallbackKeywords = keywordsLookup[mbtiTypeFromDb] || ['独特个性', '深度洞察', '持续成长'];

    // ✅ title fallback
    const titleLookup: Record<string, string> = {
        'ENFP': '灵感连接者', 'ENTP': '思维破局者', 'ESFP': '现场体验官', 'ESTP': '行动突击手',
        'INFJ': '洞察引路人', 'INFP': '价值守护者', 'ISFP': '感性创作者', 'ISTP': '冷静工程师',
        'ENFJ': '人群引导者', 'ENTJ': '战略统帅者', 'ESFJ': '关系维护者', 'ESTJ': '秩序执行官',
        'INTJ': '系统设计师', 'INTP': '思维研究员', 'ISFJ': '稳定支撑者', 'ISTJ': '现实构建者',
    };
    const fallbackTitle = titleLookup[mbtiTypeFromDb] || '深度分析报告';

    // 关键修复：应用与 getReport 相同的映射逻辑
    const report: ReportContent = {
        type: data.mbti_type || '',
        title: fallbackTitle,
        keywords: content.keywords?.length ? content.keywords : fallbackKeywords,
        baseColor: content.cognitive_os?.text || fallbackBaseColor,

        // ✅ 核心映射：social_navigation -> social（lookup查表覆盖）
        social: (() => {
            const socialLookup: Record<string, { soulmate: string, partner: string, conflict: string }> = {
                'ENFP': { soulmate: 'ISTJ / INTJ', partner: 'INFP / ENFP', conflict: 'ESTJ / ISTJ' },
                'ENTP': { soulmate: 'ISFJ / INFJ', partner: 'INTP / ENTP', conflict: 'ESFJ / ISFJ' },
                'ESFP': { soulmate: 'INTJ / ISTJ', partner: 'ISFP / ESFP', conflict: 'INFJ / INTJ' },
                'ESTP': { soulmate: 'INFJ / ISFJ', partner: 'ISTP / ESTP', conflict: 'INFP / INFJ' },
                'INFP': { soulmate: 'ESTJ / ENTJ', partner: 'INFP / ENFP', conflict: 'ISTJ / ESTJ' },
                'INFJ': { soulmate: 'ESTP / ESFP', partner: 'INTJ / INFJ', conflict: 'ESTJ / ESTP' },
                'ISFP': { soulmate: 'ENTJ / ESTJ', partner: 'ISFP / ESFP', conflict: 'INTJ / ENTJ' },
                'ISTP': { soulmate: 'ENFJ / ESFJ', partner: 'ISTP / ESTP', conflict: 'INFP / ENFJ' },
                'ENFJ': { soulmate: 'ISTP / INTP', partner: 'ENFJ / INFJ', conflict: 'ESTP / ISTP' },
                'ENTJ': { soulmate: 'ISFP / INFP', partner: 'INTJ / ENTJ', conflict: 'ESFP / ISFP' },
                'ESFJ': { soulmate: 'INTP / ISTP', partner: 'ESFJ / ISFJ', conflict: 'ENTP / INTP' },
                'ESTJ': { soulmate: 'INFP / ISFP', partner: 'ESTJ / ISTJ', conflict: 'ENFP / INFP' },
                'INTJ': { soulmate: 'ESFP / ENFP', partner: 'INTJ / INFJ', conflict: 'ISFP / ESFP' },
                'INTP': { soulmate: 'ESFJ / ENFJ', partner: 'INTP / ENTP', conflict: 'ISFJ / ESFJ' },
                'ISFJ': { soulmate: 'ENTP / ESTP', partner: 'ISFJ / ESFJ', conflict: 'INFP / ENTP' },
                'ISTJ': { soulmate: 'ENFP / ESFP', partner: 'ISTJ / ESTJ', conflict: 'INFP / ENFP' },
            };
            const s = socialLookup[mbtiTypeFromDb] || { soulmate: '', partner: '', conflict: '' };
            return {
                soulmate: { type: s.soulmate, desc: '思路、优势与你不同，但能补你短板的人。' },
                partner: { type: s.partner, desc: '价值观、节奏与你接近，相处省力的人。' },
                conflict: { type: s.conflict, desc: '核心认知差异大，容易互相消耗的人。' },
            };
        })(),

        talent: (() => {
            const talentLookup: Record<string, { strengths: string[], weaknesses: string[] }> = {
                'ENFP': { strengths: ['创意持续爆发力强', '人际连接能力出众', '情绪感染力很高'], weaknesses: ['容易频繁分心走神', '难以长期稳定坚持', '热情容易快速消退'] },
                'ENTP': { strengths: ['思维反应速度极快', '拆解复杂问题能力强', '创新点子持续不断'], weaknesses: ['执行力常常跟不上', '容易快速失去兴趣', '喜欢争辩抬杠'] },
                'ESFP': { strengths: ['气氛调节能力极强', '行动力非常直接果断', '现实感受非常敏锐'], weaknesses: ['冲动决策概率偏高', '长期规划能力较弱', '情绪容易波动'] },
                'ESTP': { strengths: ['实战解决能力突出', '抗压与适应力强', '决断速度非常快'], weaknesses: ['风险判断偏激进', '缺乏长期耐心', '容易鲁莽行事'] },
                'INFJ': { strengths: ['洞察人性能力极强', '深度共情能力突出', '长期战略意识强'], weaknesses: ['内心消耗极为严重', '情绪长期压抑隐藏', '容易过度理想化'] },
                'INFP': { strengths: ['核心价值感极稳定', '同理共情能力极强', '信念坚持度很高'], weaknesses: ['容易逃避现实压力', '情绪波动幅度较大', '行动启动能力弱'] },
                'ISFP': { strengths: ['审美与感受力突出', '对情绪变化敏感', '做事风格真实自然'], weaknesses: ['表达需求能力不足', '长期规划意识薄弱', '冲突时容易回避'] },
                'ISTP': { strengths: ['动手实操能力极强', '面对危机非常冷静', '快速解决问题'], weaknesses: ['情感表达明显不足', '对关系投入较低', '缺乏长线目标'] },
                'ENFJ': { strengths: ['群体领导感染力强', '协调关系能力突出', '鼓舞他人能力强'], weaknesses: ['容易过度消耗自己', '控制倾向较明显', '忽视自身需求'] },
                'ENTJ': { strengths: ['战略布局能力极强', '高效执行推进能力', '决策果断明确'], weaknesses: ['容易过度强势主导', '忽视他人情绪感受', '给人压迫感强'] },
                'ESFJ': { strengths: ['照顾他人能力突出', '责任感稳定可靠', '日常支持力强'], weaknesses: ['容易过度讨好他人', '回避正面冲突问题', '依赖外界认可'] },
                'ESTJ': { strengths: ['组织管理能力很强', '规则意识非常明确', '推进效率极高'], weaknesses: ['思维容易固化保守', '控制欲偏强明显', '对变化抗拒强'] },
                'INTJ': { strengths: ['系统性思维极强', '长线规划能力突出', '自我管理能力高'], weaknesses: ['情感表达较为冷淡', '对他人要求苛刻', '行动启动较慢'] },
                'INTP': { strengths: ['逻辑分析能力极强', '学习理解速度极快', '理论深度突出'], weaknesses: ['严重拖延执行任务', '容易脱离现实环境', '行动力明显不足'] },
                'ISFJ': { strengths: ['细节处理非常严谨', '忠诚稳定投入关系', '长期付出能力强'], weaknesses: ['长期压抑真实需求', '容易过度忍让退让', '对变化适应慢'] },
                'ISTJ': { strengths: ['执行力长期稳定', '责任意识非常强烈', '输出质量可靠'], weaknesses: ['思维模式较保守', '抗拒变化适应慢', '情绪表达压抑'] },
            };
            return talentLookup[mbtiTypeFromDb] || content.talent || { strengths: [], weaknesses: [] };
        })(),

        dimensions: (() => {
            const dims = content.dimensions || { decision: { title: '', content: '', limit: '' }, communication: { title: '', content: '', caution: '' }, work: { title: '', content: '', careers: [] }, love: { title: '', content: '', partner: '' } };
            const decisionLookup: Record<string, { content: string, limit: string }> = {
                'ENFP': { content: '你在做决定时，几乎第一时间依赖内心的兴奋感、直觉共鸣和情绪反馈，只要觉得"有感觉""有潜力""好像会很有意思"，就会迅速投入。你会在脑中构建理想化画面，想象未来的可能性和快乐场景，却容易下意识忽略持续执行的难度、现实资源限制和长期压力。当热情消退后，你才发现自己背负了远超预期的责任，进而产生后悔、自责甚至逃避心理。', limit: '在任何让你异常兴奋的决定前，强制写下未来三个月可能遇到的最坏现实压力、时间成本和失败代价，确认你依然愿意承担，再继续行动。' },
                'ENTP': { content: '你习惯在脑中同时生成多个方案版本，不断拆解、重组、升级和优化，追求逻辑上最优的解决路径。你会反复推演各种可能走向，享受思考本身带来的智力快感，却容易因为"还能更好"而不断推翻旧方案。你常陷入准备过度、迟迟不落地的状态，把大量精力消耗在优化阶段，而不是执行阶段。', limit: '为每个重要决策设定明确的"冻结时间点"，超过这个节点无论满意与否都必须启动执行，否则你会永远停留在设计阶段。' },
                'ESFP': { content: '你做决定时高度依赖当下的情绪体验、现实感受和现场氛围，优先选择能让自己现在开心、放松、有参与感的选项。你对未来风险、隐性成本和长期结构关注较少，更倾向先享受过程，再处理后果。当现实压力出现时，容易产生"早知道就不选这个"的后悔心理。', limit: '所有涉及金钱、关系或职业走向的选择，至少给自己24小时冷却期，避免在情绪高点直接做出不可逆决定。' },
                'ESTP': { content: '你擅长迅速识别现实机会和可操作空间，一旦看到突破口，就会果断出手，相信自己能够边做边修、临场补救。你对风险有较高容忍度，习惯用行动换经验，却容易低估复杂系统中的连锁反应。当局势失控时，才意识到代价被严重低估。', limit: '在行动前必须完整评估三种最坏结局，并确认自己有现实能力承担，否则不要仅凭自信贸然下注。' },
                'INFJ': { content: '你在做决定前，会在内心反复推演未来走向、价值意义和对他人的影响，试图找到"既正确又不伤人"的平衡点。你习惯把长远后果、道德感受和人生方向一起纳入考量，因此思考周期很长。你容易因为担心选错而不断延迟行动，在犹豫中消耗大量心理能量。', limit: '在分析超过三次后强制启动行动机制，把剩余不确定性交给实践修正，而不是继续内耗。' },
                'INFP': { content: '你做决定时非常依赖内心价值感和真实感受，只有当选择与你的信念高度一致时，才会感到安心。你会反复审视"这是不是我想成为的人"，一旦觉得违心，就会本能抗拒现实条件。你容易在理想与生存之间长期拉扯，陷入情绪性犹豫。', limit: '先解决基本生存结构，再逐步向理想靠拢，否则理想会变成负担。' },
                'ISFP': { content: '你通常依据当下的感受、环境舒适度和心理安全感来判断选择，对外界压力高度敏感。你讨厌被催促或被逼迫表态，越被施压越容易回避决定。你更倾向顺势而行，而不是主动规划，长期容易错失关键节点。', limit: '用具体选项清单替代模糊感觉，逼自己面对真实选择空间。' },
                'ISTP': { content: '你做决定时优先评估现实条件、资源消耗和执行效率，习惯选择最省力、最稳妥的解决方案。你相信问题可以边做边修，但对长期结构缺乏耐心，容易陷入"先解决眼前再说"的循环模式。', limit: '在解决当下问题时，同时预留未来升级空间，避免反复返工。' },
                'ENFJ': { content: '你在做决定时，会本能地站在多方视角思考，优先考虑对他人的影响、关系稳定度和整体氛围。你习惯把"大家是否舒服""是否会失望"放在首位，而把自己的真实需求不断往后压。你往往在表面上显得果断，内心却长期为取舍而纠结，容易因为过度负责而产生隐形消耗。', limit: '在任何重要选择前，先单独写下你的真实需求，否则你的人生会逐渐变成集体项目。' },
                'ENTJ': { content: '你做决定时以目标达成和效率最大化为核心，会快速筛选路径、资源和执行方案，优先选择最短成功路线。你对拖延、模糊和反复讨论极度不耐烦，更愿意先推进再修正。但你容易忽视情绪成本和关系摩擦，后期才发现阻力来自人心而非能力。', limit: '在定方案前强制征求至少两个反对意见，避免陷入单向决策盲区。' },
                'ESFJ': { content: '你在做决定时高度关注环境反馈、群体期待和他人评价，倾向选择让大家安心、关系稳定的方案。你害怕因为选择而引发冲突或失衡，因此容易压抑个人偏好。长期下来，你可能在"为大家负责"的角色中逐渐迷失自我方向。', limit: '定期确认：这是你想要的人生，还是你替别人维护的秩序。' },
                'ESTJ': { content: '你习惯依据经验、规则、制度和既有成功路径判断问题，信任被验证过的方法。你追求清晰结构和可控流程，对混乱和试错容忍度低。面对未知领域时，你倾向回避风险，优先选择安全路线，容易错过潜在突破点。', limit: '为探索型决策设立低风险试验区，而不是直接全面否定新可能。' },
                'INTJ': { content: '你在做决定前，会在脑中构建完整的系统模型，反复推演未来走向、风险结构和资源配置方式，力求一次选对方向。你不喜欢边走边试，而更倾向充分准备后再行动。你容易因为追求最优路径而延迟启动，错过最佳时间窗口，同时也不愿轻易承认需要调整。', limit: '用最小可行方案先启动验证，再逐步优化系统，而不是等到完美才行动。' },
                'INTP': { content: '你做决定时不断补充信息、完善逻辑模型，试图构建绝对自洽的判断体系。你对信息缺失极度敏感，担心遗漏关键变量，导致决策失真。你容易陷入"再查一点"的循环，把犹豫合理化为理性，实则拖延。', limit: '提前设定信息收集上限，到点必须决策，否则思考会变成逃避。' },
                'ISFJ': { content: '你在判断选择时，会优先参考过往经验、责任义务和他人期待，倾向选择稳妥可靠、风险最低的路径。你害怕因为冒险破坏已有秩序，因此容易被惯性牵着走。长期下来，你可能忽视自身成长需求。', limit: '定期重新评估当前路径是否仍符合你的人生阶段，而不是只因为习惯继续坚持。' },
                'ISTJ': { content: '你依靠事实、流程和逻辑体系判断问题，追求高度确定性和可控性。你习惯按规则推进，避免模糊地带和高风险选择。面对不确定机会时，你往往选择保守方案，从而减少失败概率，也同时压缩了上升空间。', limit: '在关键节点允许一次可控试错，为未来积累突破可能性。' },
            };
            const d = decisionLookup[mbtiTypeFromDb];
            if (d) { dims.decision = { title: '决策路径', content: d.content, limit: d.limit }; }
            const commLookup: Record<string, { content: string, caution: string }> = {
                'ENFP': { content: '你在沟通中高度依赖情绪流动和当下共鸣，只要气氛好、感觉对，就会非常投入表达自己。你喜欢分享想法、感受和脑洞，希望通过交流建立连接感。但当对方反应冷淡或不回应时，你容易开始自我怀疑，甚至过度补偿式输出，反而让关系产生压力。', caution: '在表达前先判断对方是否有接收空间，而不是一味用热情填补沉默，否则容易消耗彼此。' },
                'ENTP': { content: '你在沟通中习惯不断抛出观点、假设和反向思考，把交流当成思维碰撞的过程。你享受辩论和讨论本身，却容易忽略对方的情绪承受度。很多时候你觉得是在交流思想，对方却觉得被挑战或否定。', caution: '在提出反驳前，先明确表达认同部分，再进入讨论，否则容易被误解为攻击型人格。' },
                'ESFP': { content: '你更偏好轻松、真实、有互动感的交流方式，擅长用情绪、氛围和行动拉近距离。你不喜欢过度分析或严肃对话，当话题变得沉重时容易回避。遇到冲突时，常用转移话题或冷处理代替正面沟通。', caution: '当问题已经影响关系时，主动面对一次不舒服的对话，比长期逃避更安全。' },
                'ESTP': { content: '你在沟通中直接、务实、目标导向，习惯快速切入重点解决问题。你不太关注对方的情绪铺垫，容易给人"太直""太冲"的感觉。你认为高效就是尊重，但对方可能觉得被忽视。', caution: '在给方案前先给共情，否则再正确的话也容易被拒绝。' },
                'INFJ': { content: '你在沟通中非常敏感，会下意识捕捉对方的情绪变化、潜台词和真实动机。你习惯先在心里反复消化，再选择是否表达，因此常给人"话不多但很深"的感觉。当关系重要时，你会投入大量情绪理解对方，但如果长期得不到回应，容易突然冷却甚至抽离。', caution: '重要关系中要适度表达真实想法，而不是长期靠猜测和忍耐维持，否则容易突然断联式疏远。' },
                'INFP': { content: '你在沟通中高度重视真实感和情感共鸣，希望被理解内心世界，而不仅是表面事实。你不擅长直接冲突，遇到不舒服时往往选择隐忍或回避。长期压抑后，容易突然情绪爆发，让对方措手不及。', caution: '当你开始反复内耗时，就该开口表达底线，否则委屈迟早会转化成关系破裂。' },
                'ISFP': { content: '你偏好温和、自然、不压迫的交流方式，更习惯用行动代替语言表达关心。你不喜欢被追问情绪，也不擅长解释内心逻辑。当对话变得紧张或复杂时，容易选择沉默或退场。', caution: '适当用语言说明你的真实感受，否则别人容易误以为你不在乎。' },
                'ISTP': { content: '你在沟通中偏理性、克制、简洁，习惯只说必要信息，不喜欢情绪化表达。你更关注"问题怎么解决"，而不是"情绪怎么安放"。这让你显得冷静可靠，但也容易被误解为冷漠疏离。', caution: '在解决问题前先回应情绪，否则你的理性容易变成关系隔阂。' },
                'ENFJ': { content: '你在沟通中高度关注关系走向和情绪氛围，会本能地照顾每个人的感受，努力让对话保持和谐顺畅。你擅长引导话题、缓解冲突，也习惯替别人承担情绪压力。但你往往隐藏自己的真实不满，长期压抑后容易突然情绪透支。', caution: '在关心别人之前先表达自己的真实需求，否则长期付出会变成隐形怨气。' },
                'ENTJ': { content: '你沟通时目标感极强，习惯直奔主题、快速定方向、推动结果。你重视效率和清晰度，对重复解释和情绪铺垫缺乏耐心。你往往觉得自己在"解决问题"，对方却觉得被压迫或忽视。', caution: '在下结论前先确认对方是否被理解，否则再正确也难被接受。' },
                'ESFJ': { content: '你非常在意互动中的礼貌度、舒适感和群体氛围，擅长照顾场面与关系稳定。你倾向顺应多数意见，避免冲突。但当你长期委屈自己时，会在私下产生强烈情绪波动。', caution: '不要为了维持表面和谐而长期压抑真实想法，否则关系迟早失衡。' },
                'ESTJ': { content: '你习惯以事实、规则和现实效率为核心表达观点，讲话直接明确，不喜欢模糊空间。你容易在无意中压制他人表达，让对方产生被否定感。', caution: '在强调规则前先倾听动机，否则容易被视为强势控制型。' },
                'INTJ': { content: '你在沟通中习惯先在脑中构建完整逻辑框架，再选择性输出结论，因此表达往往高度概括、跳跃性强。你不喜欢反复解释显而易见的逻辑，对低效讨论缺乏耐心。别人常觉得你冷静理性，你却觉得是在节省能量。', caution: '在给结论前补充推理过程，否则别人很难真正理解你的想法来源。' },
                'INTP': { content: '你习惯从概念、逻辑和系统结构出发进行交流，喜欢拆解问题本质。你容易在表达中不断补充细节、修正说法，导致重点模糊。你更关注"是否准确"，而不是"是否好懂"。', caution: '优先给结论，再补逻辑，否则对方容易在信息中迷路。' },
                'ISFJ': { content: '你在沟通中注重责任感、稳定感和情感安全，会主动照顾他人需求。你不擅长表达不满，往往选择默默承担。长期积累后，容易突然情绪爆发，让对方措手不及。', caution: '当你开始反复忍让时，就该及时表达边界，而不是继续消耗自己。' },
                'ISTJ': { content: '你以事实、流程和现实结果为核心展开交流，讲话务实严谨，逻辑清晰。你讨厌含糊和情绪化表达，更信任明确指令。对方容易觉得你冷硬或缺乏弹性。', caution: '在坚持原则时留出解释空间，否则容易被误解为不近人情。' },
            };
            const cm = commLookup[mbtiTypeFromDb];
            if (cm) { dims.communication = { title: '沟通模式', content: cm.content, caution: cm.caution }; }
            const workLookup: Record<string, { content: string, caution: string }> = {
                'ENFP': { content: '你在工作中高度依赖兴趣驱动和意义感，一旦觉得事情"有价值""有热情"，就会爆发出极强的投入度和创造力。你擅长发想法、拉资源、带气氛，但对重复执行、细节管理和长期坚持耐心不足。当工作逐渐变成流程化任务时，你容易倦怠、拖延甚至自我怀疑。', caution: '为每个项目设定阶段性成就点，把长期目标拆成短期兴奋源，否则你很容易半途失速。' },
                'ENTP': { content: '你在工作中思维活跃，擅长发现机会、优化结构、提出新方案，对创新和系统设计极有优势。你喜欢挑战旧模式，却容易频繁推翻自己原有计划，导致项目反复修改、迟迟难以收尾。你更享受构思阶段，而不是落地阶段。', caution: '给自己绑定强执行节点和外部监督机制，否则你的才华会停留在方案层。' },
                'ESFP': { content: '你在工作中重视参与感、互动感和情绪体验，适合需要现场反应、人际沟通和氛围带动的岗位。你对枯燥流程和长期规划耐受度低，容易因为情绪波动影响效率。环境不好时，状态下滑明显。', caution: '主动建立稳定作息和流程框架，否则情绪会直接决定你的产出水平。' },
                'ESTP': { content: '你行动力强，适应力高，擅长在复杂环境中快速解决问题，面对突发状况反应极快。你更偏向边做边学，对长期规划和系统建设关注较少。容易在后期留下结构性隐患。', caution: '在冲锋前预留复盘时间，否则你会不断重复补漏洞模式。' },
                'INFJ': { content: '你在工作中高度重视使命感、价值意义和长期影响，希望自己的付出"值得""有意义"。你擅长系统思考和深度洞察，但容易把标准定得过高，对自己要求极严。你往往默默承担额外责任，却不善于表达需求，长期容易心理透支。', caution: '学会为自己设定明确边界和优先级，否则你的责任感会被无限透支。' },
                'INFP': { content: '你在工作中非常重视价值认同和情感舒适度，只有在理念一致、被尊重的环境中才能发挥最大潜力。你对机械化任务和功利导向较为抗拒，容易因为违心工作而情绪低落。面对冲突时倾向回避。', caution: '先建立基本职业稳定性，再慢慢寻找理想空间，而不是频繁逃离现实。' },
                'ISFP': { content: '你偏好安静、自由、压力较低的工作环境，擅长专注完成具体任务。你不喜欢被严格监控或过度评价，情绪安全感直接影响效率。当外界干扰过多时，你容易退缩。', caution: '主动争取清晰任务边界和评价标准，避免长期处于模糊消耗状态。' },
                'ISTP': { content: '你逻辑清晰、动手能力强，擅长解决具体问题和技术难题。你更关注实际效果，对形式主义和无效会议极度反感。你不太热衷汇报成果，容易被低估价值。', caution: '刻意提升成果表达能力，否则你的专业容易被忽视。' },
                'ENFJ': { content: '你在工作中高度关注团队氛围、协作关系和成员状态，擅长调动积极性、整合资源、化解矛盾。你往往愿意多承担一些责任来换取整体稳定，对下属和同事投入大量情绪劳动。但你容易忽视自己的疲惫感，长期处在"照顾别人"的位置上，逐渐产生隐形透支。', caution: '明确哪些问题必须别人自己解决，否则你会被不断推向情绪保姆角色。' },
                'ENTJ': { content: '你目标感极强，习惯从结果出发倒推路径，对效率、执行力和责任意识要求很高。你擅长搭建体系、制定战略、推动团队前进，在混乱环境中反而更容易脱颖而出。但你有时过于强调速度和成果，容易忽略成员承受能力，导致隐性流失。', caution: '把"人是否跟得上"纳入绩效指标，否则体系迟早失血。' },
                'ESFJ': { content: '你重视秩序感、责任感和团队稳定度，擅长维持日常运转和服务体系。你对细节敏感，执行力强，愿意为团队默默付出。但你过于在意评价和认可，容易因为讨好型工作模式而被过度使用。', caution: '学会对额外任务说"不"，否则能力越强，负担越重。' },
                'ESTJ': { content: '你逻辑清晰、规则感强，擅长制定流程、监督执行和保障效率。你追求明确分工和可控结果，对混乱和拖延容忍度极低。你容易在无意中压制不同风格的成员，让团队创新受限。', caution: '给试错和探索留出缓冲空间，否则团队会逐渐僵化。' },
                'INTJ': { content: '你在工作中高度依赖系统思维和长期规划能力，习惯先构建完整框架，再逐步推进执行。你擅长战略设计、结构优化和复杂问题拆解，对低效流程和无意义重复极度反感。你往往独立承担核心思考任务，却不太愿意频繁汇报，容易被误解为疏离或不合群。', caution: '主动让成果可视化，用阶段性输出替代沉默积累，否则你的价值容易被低估。' },
                'INTP': { content: '你在工作中以逻辑严谨和问题拆解能力见长，喜欢研究系统原理和底层机制。你对知识深度要求极高，不满足于表面解决方案。你容易陷入过度思考和准备状态，对推进节奏把控较弱，导致机会流失。', caution: '设定强制交付节点，把思考转化为可验证成果，否则专业优势难以兑现。' },
                'ISFJ': { content: '你责任心强、执行稳定，擅长在复杂环境中维持秩序和流程连续性。你对细节和他人需求非常敏感，愿意承担额外事务换取团队稳定。但你容易长期被依赖，却缺乏上升空间。', caution: '学会区分"职责内贡献"和"情感付出"，避免被长期低价消耗。' },
                'ISTJ': { content: '你做事严谨务实，注重规则、标准和流程执行，对质量和稳定性要求极高。你擅长长期项目管理和风险控制，在稳定体系中表现突出。但你对变化和试错容忍度低，容易错过新机会。', caution: '在安全范围内主动尝试新路径，为未来发展预留弹性空间。' },
            };
            const wk = workLookup[mbtiTypeFromDb];
            const careersLookup: Record<string, string[]> = {
                'ENFP': ['品牌策划', '教育培训', '社群运营'],
                'ENTP': ['创业孵化', '产品设计', '商业分析'],
                'ESFP': ['内容表现', '活动统筹', '用户体验'],
                'ESTP': ['商务谈判', '风险应对', '市场拓展'],
                'INFP': ['内容创作', '心理支持', '项目策划'],
                'INFJ': ['战略研究', '教育咨询', '公共沟通'],
                'ISFP': ['视觉设计', '手作工艺', '美学策划'],
                'ISTP': ['技术研发', '系统维护', '质量检测'],
                'ENFJ': ['人才培养', '团队管理', '对外传播'],
                'ENTJ': ['战略管理', '投资决策', '组织运营'],
                'ESFJ': ['客户管理', '行政协调', '服务运营'],
                'ESTJ': ['项目统筹', '流程管理', '成本控制'],
                'INTJ': ['系统规划', '技术研究', '知识管理'],
                'INTP': ['理论研究', '逻辑建模', '数据分析'],
                'ISFJ': ['后勤支持', '档案管理', '风险排查'],
                'ISTJ': ['审计监察', '制度建设', '标准管理'],
            };
            if (wk) { dims.work = { ...dims.work, title: '工作风格', content: wk.content, caution: wk.caution, careers: careersLookup[mbtiTypeFromDb] || dims.work?.careers || [] }; }
            const loveLookup: Record<string, { content: string, partner: string }> = {
                'ENFP': { content: '你在恋爱中高度追求情感连接、精神共鸣和浪漫体验，一旦认定对方，就会非常投入、黏人、愿意付出。你喜欢分享情绪、梦想和生活细节，希望对方成为你的"灵魂伙伴"。但当关系趋于平淡或回应减少时，你容易开始焦虑、自我怀疑，甚至过度索取情绪确认，导致关系压力上升。', partner: '能听你天马行空聊天，也会帮你把想法变成现实的人。' },
                'ENTP': { content: '你在恋爱中喜欢思想碰撞、新鲜感和精神刺激，擅长制造话题和互动乐趣。你享受暧昧、探索和可能性阶段，但当关系进入稳定期后，容易感到乏味。你有时会无意中用"辩论""理性分析"处理情感问题，让对方觉得不被理解。', partner: '能接住你跳跃式表达，还会提醒你别跑太偏的人。' },
                'ESFP': { content: '你在恋爱中热情、直接、真诚，擅长用行动、陪伴和互动表达爱意。你重视当下体验和情绪共振，希望关系轻松快乐。但你不擅长处理长期规划和深层冲突，遇到压力时容易逃避或转移注意力。', partner: '愿意陪你玩闹，也会提醒你顾好生活细节的人。' },
                'ESTP': { content: '你在亲密关系中独立感强，行动导向明显，习惯用实际行为而非语言表达关心。你讨厌情绪拉扯和复杂沟通，希望问题快速解决。但你容易低估伴侣的情感需求，让对方觉得被忽视。', partner: '不限制你折腾尝试，还能在你出问题时兜底的人。' },
                'INFJ': { content: '你在恋爱中非常重视精神连接、价值共鸣和长期可能性，往往在投入前就已经在心里构建好"未来蓝图"。你愿意为关系付出理解、包容和情绪支持，但很少主动表达自己的委屈和不满。你习惯先忍、先让、先消化，直到情绪累积到极限，才突然冷却甚至抽离，让对方措手不及。', partner: '尊重你长期规划，也愿意一起面对现实压力的人。' },
                'INFP': { content: '你在亲密关系中高度追求真诚感、灵魂契合和情感安全感，希望被深度理解和珍惜。你容易理想化伴侣和关系，在前期投入大量情感期待。一旦现实与理想出现落差，你会陷入自我怀疑和情绪内耗，表面温和，内心却翻江倒海。', partner: '不嘲笑你敏感情绪，也不会逼你快速做决定的人。' },
                'ISFP': { content: '你在恋爱中温柔、体贴、重视陪伴，更习惯用行动而不是语言表达爱意。你不擅长情绪表达，也不喜欢冲突，当关系出现问题时，往往选择沉默或退让。你希望通过"少说话、多付出"维持稳定，却容易让真实需求被忽视。', partner: '不查你、不管你，又会在关键时刻站你这边的人。' },
                'ISTP': { content: '你在亲密关系中非常重视个人空间和自主感，不喜欢被情绪绑架或频繁追问内心状态。你更习惯用实际行动表达关心，而不是甜言蜜语。当伴侣情绪需求过多时，你容易本能退缩，让对方感觉被冷落。', partner: '不天天黏你，也不会对你忽冷忽热的人。' },
                'ENFJ': { content: '你在恋爱中极度重视伴侣感受和关系稳定度，习惯主动照顾情绪、安排生活、解决问题。你希望通过付出来换取安全感和被需要感，很容易在关系中扮演"情感支柱"。但你往往忽视自己的疲惫，当付出得不到对等回应时，内心失落却不愿明说。', partner: '看见你为别人操心，也会反过来照顾你的人。' },
                'ENTJ': { content: '你在亲密关系中目标感强，习惯规划未来、推动成长、解决现实问题，希望关系不断"升级"。你重视责任与承诺，但不太擅长细腻表达情绪。当你试图用管理思维经营爱情时，容易让伴侣感到压力和控制感。', partner: '不怕和你讨论分歧，也不会被你压着走的人。' },
                'ESFJ': { content: '你在恋爱中极度重视安全感、认可感和关系稳定性，愿意为伴侣投入大量时间与精力。你善于照顾细节，但对伴侣反馈高度敏感，容易因忽视而产生强烈不安。你往往通过付出来维系关系，却忽略自我边界。', partner: '珍惜你为家庭和关系付出的细节的人。' },
                'ESTJ': { content: '你在恋爱中务实、负责、行动导向，习惯用承担责任和解决问题证明爱意。你重视稳定和未来规划，但容易忽略情绪交流的重要性。当关系出现问题时，你倾向讲道理而非共情。', partner: '尊重你做事标准，也懂得安抚你情绪的人。' },
                'INTJ': { content: '你在亲密关系中极度理性克制，习惯先评估长期匹配度、价值观一致性和未来可行性，再决定是否深入投入。你表达爱意偏含蓄，更习惯用规划、承担责任和实际行动证明重视程度。但你不擅长情绪表达，容易让伴侣觉得被隔在内心世界之外。', partner: '愿意认真听你讲逻辑，不打断你思考节奏的人。' },
                'INTP': { content: '你在恋爱中重视思想交流和精神空间，希望伴侣理解你的独立性与探索欲。你不擅长处理复杂情绪，对黏人和情绪化需求容易产生逃避心理。当关系出现问题时，你倾向先分析原因，而不是先安抚感受。', partner: '包容你发散思考，还能帮你把事情收尾的人。' },
                'ISFJ': { content: '你在亲密关系中温柔、稳定、责任感强，习惯通过照顾生活细节、长期陪伴和默默付出来表达爱意。你不轻易表达不满，往往选择忍让换取和平。但长期压抑后容易突然情绪崩溃。', partner: '记得你的付出，也会主动回应你关心的人。' },
                'ISTJ': { content: '你在恋爱中务实、忠诚、重视承诺，更关注现实责任和长期稳定。你不擅长浪漫表达，习惯用守规则、履责任来证明爱意。你容易忽视情绪交流的重要性，让关系变得功能化。', partner: '尊重你做事方式，也愿意表达情绪的人。' },
            };
            const lv = loveLookup[mbtiTypeFromDb];
            if (lv) { dims.love = { title: '亲密关系', content: lv.content, partner: lv.partner }; }
            return dims;
        })(),

        shareContent: {
            baseColor: (content.cognitive_os?.text || fallbackBaseColor).replace(/你/g, '我'),
            interactionGuide: (() => {
                const guideLookup: Record<string, string[]> = {
                    'ENFP': ['别用规则管死我，我会慢慢对你失去热情', '敷衍我想法，比直接拒绝更伤人', '别逼我稳定，我需要不断变化才有生命力'],
                    'ENTP': ['别把我讨论当攻击，我只是讨厌无脑结论', '一否定我，我立刻关闭沟通频道', '给我时间跑逻辑，催我只会更乱'],
                    'ESFP': ['别把关系搞得太严肃，我会想逃', '少教育我，多陪我体验生活', '你不参与我的世界，我也会慢慢抽离'],
                    'ESTP': ['拐弯抹角只会让我不耐烦', '拖太久的事，我会直接接管', '怀疑我能力，比吵架更致命'],
                    'INFJ': ['别强行撬开我内心，我会立刻关门', '不尊重我的信念，我会彻底疏远', '我安静时不是冷，是在自我修复'],
                    'INFP': ['别踩我的价值观，那是我的底线', '冷暴力会让我彻底心死', '没安全感，我一句真话都不会说'],
                    'ISFP': ['控制我生活，只会让我更沉默', '忽视我感受，我不会吵但会走远', '比较我和别人，是最快伤我的方式'],
                    'ISTP': ['情绪轰炸只会让我自动断联', '有问题不说清，我懒得猜', '粘太紧，我会直接后退'],
                    'ENFJ': ['别把我的付出当义务', '一直索取不回馈，我会耗光', '我照顾别人，也需要被照顾'],
                    'ENTJ': ['不守承诺，会直接降低你信用分', '情绪化沟通，只会让我失去耐心', '三天两头改主意，我会放弃合作'],
                    'ESFJ': ['我的好不是理所当然', '冷处理等于慢性伤害我', '不表达感谢，我会慢慢收回热情'],
                    'ESTJ': ['敷衍规则，就是对我不尊重', '拖延等于浪费我的生命', '混乱环境，会让我暴躁'],
                    'INTJ': ['打断我思路，比吵架还烦', '质疑我专业，我会直接拉黑', '情绪失控，会让我彻底降权你'],
                    'INTP': ['催我做决定，只会拖更久', '不给思考空间，我会摆烂', '要我装正常，比工作还累'],
                    'ISFJ': ['忽视我的付出，我会心寒', '一直忍不说，不代表没情绪', '不稳定回应，会慢慢击垮我'],
                    'ISTJ': ['不守时就是不尊重我', '随意改计划让我很焦虑', '含糊沟通等于浪费时间'],
                };
                return guideLookup[mbtiTypeFromDb] || content.shareContent?.interactionGuide || [];
            })()
        },



        // ✅ 关键：deviation 从数据库读取 + 用最新文案函数覆盖旧数据（与 getReport 一致）
        deviation: (() => {
            const perception = content.perception;
            const scripts = content.calibration_scripts;
            const dbDeviation = content.deviation;

            if (!perception && !scripts && !dbDeviation) return undefined;

            // 覆盖 selfPerception
            const selfViewLookup: Record<string, string> = {
                'ENFP': '你觉得自己只是想让生活更有温度和连接感，喜欢分享想法、交流情绪、碰撞灵感，并不是为了博关注或刷存在感。',
                'ENTP': '你觉得自己只是爱思考、爱试错、爱推翻旧观点，希望不断接近更好的答案，并不是刻意唱反调。',
                'ESFP': '你觉得自己只是珍惜当下、重视体验，希望把生活过得真实快乐，而不是逃避规划。',
                'ESTP': '你觉得自己只是反应快、行动果断，习惯先解决问题再总结经验，并不是鲁莽行事。',
                'INFJ': '你觉得自己只是习惯提前思考意义与方向，希望做有价值的事，而不是想复杂化问题。',
                'INFP': '你觉得自己只是想忠于内心价值，不愿敷衍生活和关系，并不是脆弱敏感。',
                'ISFP': '你觉得自己只是想按舒服真实的方式生活，尊重感受和美感，并不是逃避责任。',
                'ISTP': '你觉得自己只是更相信逻辑和经验，习惯独立解决问题，并不是冷淡疏离。',
                'ENFJ': '你觉得自己只是希望身边的人和事情变得更好，愿意主动付出，并不是爱管闲事。',
                'ENTJ': '你觉得自己只是追求效率和成果，希望事情推进顺利，并不是想控制别人。',
                'ESFJ': '你觉得自己只是希望关系和环境稳定舒服，照顾大家情绪，并不是讨好型人格。',
                'ESTJ': '你觉得自己只是尊重规则和流程，希望事情靠谱推进，并不是死板保守。',
                'INTJ': '你觉得自己只是习惯做长期规划、降低风险，希望少走弯路，并不是高冷。',
                'INTP': '你觉得自己只是想把问题想透彻，不愿草率判断，并不是拖延逃避。',
                'ISFJ': '你觉得自己只是想把事情默默照顾好，不给别人添麻烦，并不是没主见。',
                'ISTJ': '你觉得自己只是重视责任与承诺，希望一切可控可靠，并不是顽固守旧。',
            };
            const selfPerception = selfViewLookup[mbtiTypeFromDb] || dbDeviation?.selfPerception || perception?.self_view || '';

            const peerViewLookup: Record<string, string> = {
                'ENFP': '在别人眼中，你展现出 ENFP 的热情外向特质，总是气氛担当、话题发动机，但也容易被误解为太情绪化或不够稳重。',
                'ENTP': '在别人看来，你带着 ENTP 的跳跃与犀利思维，总是点子不断、敢质疑权威，但有时会被觉得太爱辩论。',
                'ESFP': '在别人眼中，你呈现出 ESFP 的活力与感染力，总是爱玩爱笑、带动气氛，但容易被低估深度。',
                'ESTP': '在别人看来，你体现出 ESTP 的行动派特质，果敢直接、临场应变强，但有时被认为不够谨慎。',
                'INFJ': '在别人眼中，你带着 INFJ 的洞察与理想主义气质，显得深沉有想法，但也容易被觉得距离感强。',
                'INFP': '在别人看来，你呈现出 INFP 的细腻与理想感受力，温柔真诚，但也容易被理解为情绪化。',
                'ISFP': '在别人眼中，你带着 ISFP 的安静审美特质，温和随性，却常被低估主见与坚持。',
                'ISTP': '在别人看来，你体现出 ISTP 的冷静理性风格，低调务实，但容易显得不够热络。',
                'ENFJ': '在别人眼中，你呈现出 ENFJ 的领导与共情特质，温暖可靠，但有时会被觉得操心过多。',
                'ENTJ': '在别人看来，你展现出 ENTJ 的目标导向与执行力，强势果断，但容易给人压力感。',
                'ESFJ': '在别人眼中，你带着 ESFJ 的体贴与责任特质，可靠周到，但有时过于在意评价。',
                'ESTJ': '在别人看来，你体现出 ESTJ 的管理与执行能力，严谨高效，但容易显得强硬。',
                'INTJ': '在别人眼中，你呈现出 INTJ 的战略与独立思考特质，理性深沉，却常被误解为疏远。',
                'INTP': '在别人看来，你带着 INTP 的逻辑探索气质，思考深入，但容易显得游离现实。',
                'ISFJ': '在别人眼中，你呈现出 ISFJ 的稳定与奉献特质，值得信赖，却容易被忽视需求。',
                'ISTJ': '在别人看来，你体现出 ISTJ 的严谨与踏实特质，可靠稳重，但显得不够灵活。',
            };

            const originalOthersPerception = dbDeviation?.othersPerception
                || (typeof perception?.peer_view === 'string' ? perception.peer_view : perception?.peer_view?.desc)
                || perception?.othersPerception
                || '';
            const peerMBTI = perception?.peer_view?.type
                || (dbDeviation?.othersPerception?.match?.(/([A-Z]{4})/)?.[1])
                || '';
            const hasPeer = !!peerMBTI && !!originalOthersPerception;
            const othersPerception = hasPeer
                ? (peerViewLookup[peerMBTI] || originalOthersPerception)
                : originalOthersPerception;

            return {
                selfPerception,
                othersPerception,
                similarities: hasPeer ? getSimilarities(mbtiTypeFromDb, peerMBTI) : (dbDeviation?.similarities || scripts?.match?.short_desc || ''),
                differences: hasPeer ? getDifferences(mbtiTypeFromDb, peerMBTI) : (dbDeviation?.differences || scripts?.temperature?.short_desc || ''),
                dimensionAnalysis: hasPeer
                    ? (() => {
                        const freshAnalysis = calculateDimensionAnalysis(mbtiTypeFromDb, peerMBTI, content.self_scores);
                        const dbAnalysis = dbDeviation?.dimensionAnalysis || [];
                        return freshAnalysis.map((fresh: any, i: number) => ({
                            ...fresh,
                            selfValue: dbAnalysis[i]?.selfValue ?? fresh.selfValue,
                            peerValue: dbAnalysis[i]?.peerValue ?? fresh.peerValue,
                        }));
                    })()
                    : (dbDeviation?.dimensionAnalysis || []),
                conclusion: hasPeer
                    ? {
                        ...getCalibrationConclusion(mbtiTypeFromDb, peerMBTI, calculateDimensionAnalysis(mbtiTypeFromDb, peerMBTI, content.self_scores)),
                    }
                    : (dbDeviation?.conclusion || {
                        archetype: scripts?.temperature?.title || '未定型',
                        desc: scripts?.temperature?.full_desc || '...',
                        suggestion: scripts?.temperature?.suggestion || '...',
                    }),
            };
        })(),

        // ✅ 动态雷达图数据
        radarData: content.radarData || undefined,
    };

    return report;
}

/**
 * 提交他测评估
 * 1. 算分得出他评 MBTI
 * 2. 读取原报告数据
 * 3. 融合 peer_view 数据
 * 4. 写回数据库
 */
export async function submitPeerAssessment(reportId: string, answers: string[]): Promise<boolean> {
    try {
        // 1. 算出他评 MBTI
        const scores: Record<string, number> = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
        answers.forEach((val) => {
            if (scores[val] !== undefined) {
                scores[val]++;
            }
        });

        const dim1 = scores.E >= scores.I ? 'E' : 'I';
        const dim2 = scores.S >= scores.N ? 'S' : 'N';
        const dim3 = scores.T >= scores.F ? 'T' : 'F';
        const dim4 = scores.J >= scores.P ? 'J' : 'P';
        const peerMBTI = `${dim1}${dim2}${dim3}${dim4}`;

        // ✅ 他评雷达图数据（固定值查表）
        const radarLookup: Record<string, number[]> = {
            'ENFP': [86, 88, 88, 52, 50, 84],
            'ENTP': [88, 50, 86, 82, 52, 86],
            'ESFP': [90, 84, 52, 50, 48, 88],
            'ESTP': [88, 48, 50, 84, 50, 90],
            'INFJ': [50, 88, 90, 54, 86, 52],
            'INFP': [52, 90, 88, 50, 52, 48],
            'ISFP': [54, 86, 52, 48, 50, 50],
            'ISTP': [52, 48, 50, 88, 52, 54],
            'ENFJ': [88, 88, 84, 54, 84, 86],
            'ENTJ': [86, 50, 82, 90, 88, 90],
            'ESFJ': [90, 86, 54, 52, 86, 84],
            'ESTJ': [88, 48, 52, 88, 90, 90],
            'INTJ': [50, 50, 90, 88, 88, 54],
            'INTP': [52, 48, 88, 86, 52, 50],
            'ISFJ': [54, 88, 52, 50, 90, 52],
            'ISTJ': [52, 48, 50, 90, 90, 54],
        };
        const peerRadarValues = radarLookup[peerMBTI] || [50, 50, 50, 50, 50, 50];
        const peerRadarData = [
            { axis: '连接力', value: peerRadarValues[0] },
            { axis: '共振力', value: peerRadarValues[1] },
            { axis: '想象力', value: peerRadarValues[2] },
            { axis: '判断力', value: peerRadarValues[3] },
            { axis: '稳定力', value: peerRadarValues[4] },
            { axis: '行动力', value: peerRadarValues[5] },
        ];

        // 2. 获取原有报告
        const { data: currentReport, error: fetchError } = await supabase
            .from('personality_reports')
            .select('content')
            .eq('id', reportId)
            .single();

        if (fetchError) {
            console.error("[Peer] 获取报告失败:", fetchError);
            throw fetchError;
        }

        if (!currentReport || !currentReport.content) {
            throw new Error("报告不存在或数据为空");
        }

        // 3. 融合数据 (解锁校准报告)
        const oldContent = currentReport.content;
        const selfMBTI = oldContent.mbti_type || 'INTJ';
        const selfScores = oldContent.self_scores; // createReport 保存的自评各维度得分

        // 根据自评和他评 真实 scores 计算四维度偏差值
        const dimensionAnalysis = calculateDimensionAnalysis(selfMBTI, peerMBTI, selfScores, scores);

        // peerView 查表（与 getReport/getReportById 保持一致）
        const peerViewLookup: Record<string, string> = {
            'ENFP': '在别人眼中，你展现出 ENFP 的热情外向特质，总是气氛担当、话题发动机，但也容易被误解为太情绪化或不够稳重。',
            'ENTP': '在别人看来，你带着 ENTP 的跳跃与犀利思维，总是点子不断、敢质疑权威，但有时会被觉得太爱辩论。',
            'ESFP': '在别人眼中，你呈现出 ESFP 的活力与感染力，总是爱玩爱笑、带动气氛，但容易被低估深度。',
            'ESTP': '在别人看来，你体现出 ESTP 的行动派特质，果敢直接、临场应变强，但有时被认为不够谨慎。',
            'INFJ': '在别人眼中，你带着 INFJ 的洞察与理想主义气质，显得深沉有想法，但也容易被觉得距离感强。',
            'INFP': '在别人看来，你呈现出 INFP 的细腻与理想感受力，温柔真诚，但也容易被理解为情绪化。',
            'ISFP': '在别人眼中，你带着 ISFP 的安静审美特质，温和随性，却常被低估主见与坚持。',
            'ISTP': '在别人看来，你体现出 ISTP 的冷静理性风格，低调务实，但容易显得不够热络。',
            'ENFJ': '在别人眼中，你呈现出 ENFJ 的领导与共情特质，温暖可靠，但有时会被觉得操心过多。',
            'ENTJ': '在别人看来，你展现出 ENTJ 的目标导向与执行力，强势果断，但容易给人压力感。',
            'ESFJ': '在别人眼中，你带着 ESFJ 的体贴与责任特质，可靠周到，但有时过于在意评价。',
            'ESTJ': '在别人看来，你体现出 ESTJ 的管理与执行能力，严谨高效，但容易显得强硬。',
            'INTJ': '在别人眼中，你呈现出 INTJ 的战略与独立思考特质，理性深沉，却常被误解为疏远。',
            'INTP': '在别人看来，你带着 INTP 的逻辑探索气质，思考深入，但容易显得游离现实。',
            'ISFJ': '在别人眼中，你呈现出 ISFJ 的稳定与奉献特质，值得信赖，却容易被忽视需求。',
            'ISTJ': '在别人看来，你体现出 ISTJ 的严谨与踏实特质，可靠稳重，但显得不够灵活。',
        };
        const peerViewDesc = peerViewLookup[peerMBTI] || `在别人眼中，你呈现出 ${peerMBTI} 的典型特质。`;

        const newContent = {
            ...oldContent,
            perception: {
                ...oldContent.perception,
                peer_view: {
                    type: peerMBTI,
                    desc: peerViewDesc
                }
            },
            radarData: (oldContent.radarData || []).map((item: any, index: number) => ({
                ...item,
                secondaryValue: peerRadarData[index]?.value || 0
            })),
            deviation: {
                ...oldContent.deviation,
                othersPerception: peerViewDesc,
                selfPerception: oldContent.perception?.self_view || `自评 ${selfMBTI} 类型`,
                similarities: getSimilarities(selfMBTI, peerMBTI),
                differences: getDifferences(selfMBTI, peerMBTI),

                // ✅ 四维度对比数据 (用于全维校准图表)
                dimensionAnalysis: dimensionAnalysis,

                // ✅ 校准结论 (用于底部大黑卡)
                conclusion: {
                    ...getCalibrationConclusion(selfMBTI, peerMBTI, dimensionAnalysis),
                }
            }
        };

        // 4. 写回数据库
        const { error: updateError } = await supabase
            .from('personality_reports')
            .update({ content: newContent })
            .eq('id', reportId);

        if (updateError) {
            console.error("[Peer] 更新失败:", updateError);
            throw updateError;
        }

        return true;

    } catch (err) {
        console.error("[Peer] submitPeerAssessment 异常:", err);
        throw err;
    }
}

/**
 * 计算四维度对比分析数据
 */
function calculateDimensionAnalysis(
    selfMBTI: string,
    peerMBTI: string,
    selfScores?: Record<string, number>,
    peerScores?: Record<string, number>
) {
    // 用真实答题比例计算维度值 (0=偏左, 100=偏右)
    // EI 维度：0=纯E, 100=纯I；SN 维度：0=纯S, 100=纯N；以此类推
    const calcPercent = (scores: Record<string, number> | undefined, leftKey: string, rightKey: string, mbtiChar: string) => {
        if (scores) {
            const total = (scores[leftKey] || 0) + (scores[rightKey] || 0);
            if (total > 0) {
                // 右侧字母的占比 * 100
                return Math.round(((scores[rightKey] || 0) / total) * 100);
            }
        }
        // 没有真实分数时用 MBTI 字母的固定映射（无随机）
        const fallback: Record<string, number> = {
            'E': 30, 'I': 70,
            'S': 30, 'N': 70,
            'T': 30, 'F': 70,
            'J': 30, 'P': 70
        };
        return fallback[mbtiChar] ?? 50;
    };

    // 根据 selfValue 与 peerValue 差值判断匹配等级
    type MatchLevel = 'high' | 'medium' | 'mixed' | 'low';
    const getMatchLevel = (sv: number, pv: number): MatchLevel => {
        const diff = Math.abs(sv - pv);
        if (diff <= 10) return 'high';
        if (diff <= 25) return 'medium';
        if (diff <= 40) return 'mixed';
        return 'low';
    };

    // 四级描述
    const getEIDesc = (level: MatchLevel) => {
        switch (level) {
            case 'high': return '你对外展现的状态，和你真实的能量节奏几乎一致。别人看到的你，基本就是你真实的样子——不需要刻意扮演，也很少硬撑。';
            case 'medium': return '整体来说，别人对你的社交状态判断是准的，但他们可能低估了你偶尔的疲惫感。你看起来游刃有余，其实有时也需要独处回血。';
            case 'mixed': return '你在不同场合切换得很自然：有时外向得像个社交发动机，有时却突然消失。别人看到的是你的"在线状态"，但真正的充电方式只有你自己懂。';
            case 'low': return '你真实的能量需求，和外界理解存在明显落差。你可能习惯性"演得很精神"，久而久之，连别人都忘了你其实很容易累。';
        }
    };
    const getSNDesc = (level: MatchLevel) => {
        switch (level) {
            case 'high': return '你思考问题的方式非常稳定，不管是关注细节还是全局，别人看到的逻辑路径，和你内心运作基本一致。';
            case 'medium': return '你的思考方式大体清晰，但在表达时会做一些调整。有时你明明想得很深，却只说一半。';
            case 'mixed': return '你内心的思考路线很复杂，但对外表达时经常"简化输出"。别人以为你懂得很具体，其实你脑子里跑的是另一套系统。';
            case 'low': return '你真实的思考深度，很容易被低估。你可能懒得解释太多，久了就被误以为"没想那么多"。';
        }
    };
    const getTFDesc = (level: MatchLevel) => {
        switch (level) {
            case 'high': return '你做决定时的价值取向非常稳定，别人基本能感知到你真正看重什么，很少误判你的立场。';
            case 'medium': return '你的判断逻辑大体清楚，但在关系里会适当软化。理性和情感之间，你经常在做微调。';
            case 'mixed': return '你在不同关系中，呈现出不同的决策侧面。有时很冷静，有时又特别在乎感受，连别人都摸不透你真正的底线。';
            case 'low': return '你的真实判断标准，经常被误读。你习惯先照顾别人感受，结果反而让人误会你没有立场。';
        }
    };
    const getJPDesc = (level: MatchLevel) => {
        switch (level) {
            case 'high': return '你的生活节奏与对外呈现高度一致。你是有序就是有序，松弛就是松弛，很少给人错觉。';
            case 'medium': return '整体节奏稳定，但你偶尔会在私下"摆烂回血"。别人看到的是规律版你，看不到混乱版你。';
            case 'mixed': return '你的生活状态存在明显双轨：对外看起来很稳，私下却经常临时调整、随性应变。';
            case 'low': return '你的真实节奏感被严重误判。你可能早已很疲惫，但仍维持着"我还OK"的外壳。';
        }
    };

    // 先算出各维度的值
    const eiSelf = calcPercent(selfScores, 'E', 'I', selfMBTI[0]);
    const eiPeer = calcPercent(peerScores, 'E', 'I', peerMBTI[0]);
    const snSelf = calcPercent(selfScores, 'S', 'N', selfMBTI[1]);
    const snPeer = calcPercent(peerScores, 'S', 'N', peerMBTI[1]);
    const tfSelf = calcPercent(selfScores, 'T', 'F', selfMBTI[2]);
    const tfPeer = calcPercent(peerScores, 'T', 'F', peerMBTI[2]);
    const jpSelf = calcPercent(selfScores, 'J', 'P', selfMBTI[3]);
    const jpPeer = calcPercent(peerScores, 'J', 'P', peerMBTI[3]);

    return [
        {
            label: '能量',
            left: 'E (外向)',
            right: 'I (内向)',
            selfValue: eiSelf,
            peerValue: eiPeer,
            desc: getEIDesc(getMatchLevel(eiSelf, eiPeer)),
        },
        {
            label: '信息',
            left: 'S (实感)',
            right: 'N (直觉)',
            selfValue: snSelf,
            peerValue: snPeer,
            desc: getSNDesc(getMatchLevel(snSelf, snPeer)),
        },
        {
            label: '决策',
            left: 'T (思考)',
            right: 'F (情感)',
            selfValue: tfSelf,
            peerValue: tfPeer,
            desc: getTFDesc(getMatchLevel(tfSelf, tfPeer)),
        },
        {
            label: '生活',
            left: 'J (判断)',
            right: 'P (感知)',
            selfValue: jpSelf,
            peerValue: jpPeer,
            desc: getJPDesc(getMatchLevel(jpSelf, jpPeer)),
        },
    ];
}

/**
 * 分析自评和他评的共性（三种状态）
 */
function getSimilarities(selfMBTI: string, peerMBTI: string): string {
    let matchCount = 0;
    for (let i = 0; i < 4; i++) {
        if (selfMBTI[i] === peerMBTI[i]) matchCount++;
    }

    if (matchCount >= 4) {
        return '自评与他评完全吻合——你对自己的认知非常清晰，外在呈现与内在状态高度统一。这种一致性是信任关系的基石。';
    } else if (matchCount >= 3) {
        return '核心人格特质高度一致：你在大多数维度上的自我认知都能被他人准确感知，说明你的自我表达清晰且真实。';
    } else if (matchCount >= 2) {
        return '在部分关键维度上，你的自我认知与他人观察一致。这些一致的维度可能是你最稳定、最本真的人格底色。';
    } else if (matchCount >= 1) {
        return '至少在一个维度上达成共识——这可能是你无论在什么场景下都不会改变的那部分自己。';
    } else {
        return '自评与他评视角差异较大，这往往意味着你在不同场景中展现了完全不同的一面。这不是矛盾，而是丰富。';
    }
}

/**
 * 分析自评和他评的分歧（中性表述）
 */
function getDifferences(selfMBTI: string, peerMBTI: string): string {
    const diffDimensions: string[] = [];
    const dimNames = ['能量获取', '信息处理', '决策方式', '生活态度'];

    for (let i = 0; i < 4; i++) {
        if (selfMBTI[i] !== peerMBTI[i]) {
            diffDimensions.push(dimNames[i]);
        }
    }

    if (diffDimensions.length === 0) {
        return '没有明显分歧。你在他人眼中和自己心中是同一个人——这种表里如一值得珍惜。';
    } else if (diffDimensions.length <= 2) {
        return `在「${diffDimensions.join('」和「')}」维度上存在差异。这很正常——每个人都会在特定场景中展现不同侧面，这恰恰说明你具备灵活适应的能力。`;
    } else {
        return `在「${diffDimensions.join('」「')}」等多个维度上存在差异。这说明你的"对外模式"和"内在模式"差别较大，你可能习惯根据环境调整自己的表达方式。`;
    }
}

/**
 * 生成校准原型标题（三种状态）
 */
/**
 * 12 种校准结论人格命中逻辑
 * 优先级：C → D → B → A（保证只落一个结果）
 * dimensionAnalysis 可选，用于 A2 判定（极端分数检测）
 */
function getCalibrationConclusion(
    selfMBTI: string,
    peerMBTI: string,
    dimensionAnalysis?: Array<{ selfValue: number; peerValue: number }>
): { archetype: string; desc: string; suggestion: string } {
    // 各维度是否一致
    const eiSame = selfMBTI[0] === peerMBTI[0];
    const snSame = selfMBTI[1] === peerMBTI[1];
    const tfSame = selfMBTI[2] === peerMBTI[2];
    const jpSame = selfMBTI[3] === peerMBTI[3];

    const diffDims = [!eiSame, !snSame, !tfSame, !jpSame];
    const diffCount = diffDims.filter(Boolean).length;

    // T/F 方向性判断
    const selfIsT = selfMBTI[2] === 'T';
    const peerIsT = peerMBTI[2] === 'T';
    const tfReversed = !tfSame; // T/F 不同即反向

    // 是否有极端分数（用于 A2）
    const hasExtreme = dimensionAnalysis?.some(
        d => d.selfValue <= 20 || d.selfValue >= 80 || d.peerValue <= 20 || d.peerValue >= 80
    ) ?? false;

    // 是否有完全反向的维度对（用于 D4）
    const hasFullReverse = (!eiSame && !jpSame) || (!eiSame && !tfSame) || (!snSame && !tfSame) || (!snSame && !jpSame) || (!eiSame && !snSame) || (!tfSame && !jpSame);

    type ConclusionId = 'A1' | 'A2' | 'B1' | 'B2' | 'B3' | 'B4' | 'C1' | 'C2' | 'D1' | 'D2' | 'D3' | 'D4';

    let id: ConclusionId;

    // === 优先级 D：3-4 维度不同（最高优先级） ===
    if (diffCount === 4) {
        id = 'D2'; // 四个维度全部不同 → 人格分区运行体
    } else if (diffCount === 3 && !eiSame) {
        id = 'D3'; // 三个不同且包含 E/I → 双轨人生模式号
    } else if (diffCount >= 2 && hasFullReverse) {
        id = 'D4'; // 至少两个不同且有一组完全反向 → 多面自我管理型
    } else if (diffCount === 3) {
        id = 'D1'; // 三个维度不同 → 多身份并行玩家
    }
    // === 优先级 C：T/F 方向相反（仅差异维度 ≤2 时触发） ===
    else if (tfReversed && selfIsT && !peerIsT && diffCount <= 2) {
        id = 'C1'; // 自测T，他测F → 情绪缓冲担当派
    } else if (tfReversed && !selfIsT && peerIsT && diffCount <= 2) {
        id = 'C2'; // 自测F，他测T → 理性防御派选手
    }
    // === 优先级 B：仅 1 维度不同 ===
    else if (diffCount === 1 && !eiSame) {
        id = 'B1'; // 只有 E/I 不同 → 场景切换高手派
    } else if (diffCount === 1 && !snSame) {
        id = 'B2'; // 只有 S/N 不同 → 气氛调节担当王
    } else if (diffCount === 1 && !tfSame) {
        id = 'B3'; // 只有 T/F 不同 → 判断切换型选手
    } else if (diffCount === 1 && !jpSame) {
        id = 'B4'; // 只有 J/P 不同 → 节奏调节模式体
    }
    // === 优先级 A：全部一致 ===
    else if (diffCount === 0 && hasExtreme) {
        id = 'A2'; // 四维一致但有极端分数 → 内核自洽派选手
    } else if (diffCount === 0) {
        id = 'A1'; // 四维完全一致 → 稳场核心担当型
    }
    // === Fallback: diffCount === 2 但不满足 D4 ===
    else {
        id = 'D4'; // 两维度不同的通用兜底 → 多面自我管理型
    }

    // 结论内容查表
    const conclusions: Record<ConclusionId, { archetype: string; desc: string; suggestion: string }> = {
        'A1': {
            archetype: '稳场核心担当型',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在四个维度上保持高度一致，说明你在不同关系与情境中呈现出的性格结构非常稳定。你对自己的认知与他人对你的感受之间差距较小，做事风格、判断逻辑和情绪表达基本处于同一轨道。这种一致性让你更容易建立长期信任关系，也更容易成为团队或家庭中的"稳定点"。但同时，高度稳定也可能降低你对新可能性的敏感度。`,
            suggestion: '在保持核心优势的同时，适度尝试不同角色或新环境，为自己的性格系统增加弹性空间，避免长期固化。',
        },
        'A2': {
            archetype: '内核自洽派选手',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在四个维度上完全一致，且部分维度呈现出较为明显的偏向特征，说明你的性格结构已经形成较为成熟而稳定的运行模式。你对价值判断、信息处理与行动节奏有清晰而固定的内在标准，并且在不同场合中能够保持高度一致。这种自洽性让你具备强烈的个人风格，但也可能让外界较难影响你的既有判断。`,
            suggestion: '定期检视自己的判断框架，在重要决策中主动引入不同视角作为参考，防止长期陷入单一逻辑循环。',
        },
        'B1': {
            archetype: '场景切换高手派',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在 E/I 维度上存在差异，说明你在社交能量的使用方式上，会根据环境自动调整。在熟悉或安全的场合中，你可能更内敛、独处导向；而在工作、社交或责任场景中，则会主动调高外向度，承担更多互动角色。这种切换能力让你适应性很强，但也意味着你需要持续管理自己的能量消耗，容易在长期高负荷下产生隐性疲惫。`,
            suggestion: '留意哪些社交场合让你明显透支，适当减少"必须在线"的时间，为自己保留稳定的恢复空间。',
        },
        'B2': {
            archetype: '气氛调节担当王',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在 S/N 维度上出现差异，说明你在信息处理方式上具有明显的双重视角。在内心层面，你可能更关注整体趋势、可能性或长期方向；而在对外表达时，别人更容易感受到你对细节、现实条件或执行层面的重视。这种切换让你在沟通中更具弹性，但也可能让你在表达真实思考时有所保留。`,
            suggestion: '在关键讨论中，尝试明确区分"我真实的想法"和"我为了好沟通做的简化版本"，避免长期压缩真实判断。',
        },
        'B3': {
            archetype: '判断切换型选手',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在 T/F 维度上存在轻度差异，说明你在做判断时，会根据关系和情境灵活调整理性与情感的比例。有时你更强调逻辑与效率，有时则更重视感受与关系平衡。这种调节能力让你在人际互动中较为圆融，但也可能让你在部分情境中感到"到底该听谁的"变得模糊。`,
            suggestion: '在重要决策前，为自己设定一个固定判断标准，先独立完成判断，再进入协商阶段，减少摇摆感。',
        },
        'B4': {
            archetype: '节奏调节模式体',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在 J/P 维度上存在差异，说明你在生活与工作节奏的管理方式上具有明显弹性。在内心层面，你可能偏向计划、有序或提前准备；而在实际表现中，别人更容易看到你随机应变、临场调整的一面。这种节奏调节能力让你应对变化更加从容，但也可能削弱长期规划的稳定性。`,
            suggestion: '为重要目标设置"最低执行框架"，即使在灵活调整时，也确保核心计划不被频繁打断。',
        },
        'C1': {
            archetype: '情绪缓冲担当派',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在 T/F 维度上呈现出明显反向：你内心更倾向于用理性标准做判断，但在实际互动中，别人更容易感受到你的体贴与照顾。这说明你在关系和合作场景中，往往会主动压低自己的逻辑优先级，把情绪稳定和关系安全放在前面。这种"缓冲型"行为让你成为可靠的支持者，但也可能让你的真实立场被长期弱化。`,
            suggestion: '在重要决策前，先把自己的真实判断写下来，再进入讨论或协商过程，避免在压力环境下自动让步，逐步找回判断主权。',
        },
        'C2': {
            archetype: '理性防御派选手',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在 T/F 维度上出现反向变化：你内心更关注感受与价值共鸣，但在外部环境中，别人更容易看到你理性、克制的一面。这通常意味着你在面对压力、竞争或不确定关系时，会主动切换到"理性防御模式"，用逻辑和规则保护自己的情绪边界。这种策略有助于短期稳定，却可能让亲近的人难以理解你的真实感受。`,
            suggestion: '在安全关系中，尝试先表达感受，再进入理性分析流程，让重要的人更早接触你的真实动机，减少误解与心理距离。',
        },
        'D1': {
            archetype: '多身份并行玩家',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在三个维度上出现明显差异，说明你在不同关系和环境中，会自动切换不同的身份模式来应对现实需求。在工作、家庭或亲密关系中，你往往启用不同的表达方式、判断逻辑和行动节奏，以维持整体稳定。这种并行运行能力让你具备很强的适应力，但也意味着你需要持续消耗精力管理这些状态切换，久而久之，容易忽略自己真正偏好的生活方式。`,
            suggestion: '为自己预留一段无需扮演任何角色的固定时间，比如独处或深度兴趣时间，逐步减少不必要的切换，让不同状态慢慢回归统一。',
        },
        'D2': {
            archetype: '人格分区运行体',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在四个维度上全部呈现不同方向，说明你在不同情境中形成了较为明确的"分区运行模式"。在部分场合中，你展现出高度理性与秩序感，而在其他环境下，又可能表现出更感性或随性的状态。这种分区机制帮助你在复杂环境中保持运转效率，但长期来看，也可能削弱内在一致感，使你在独处时感到模糊或疲惫。`,
            suggestion: '尝试记录自己在不同场景下的状态变化，找出重复出现的模式，有意识地减少过度分裂的角色配置，建立更稳定的核心节奏。',
        },
        'D3': {
            archetype: '双轨人生模式号',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在三个维度上存在差异，且包含 E/I 的明显变化，说明你在社交能量和行为策略上存在双轨运行特征。在某些场合，你表现得外向积极、反应迅速；而在另一部分时间里，则更倾向于内敛独处、降低外部互动。这种双轨结构让你在不同环境中保持弹性，但也可能导致精力分配失衡，出现阶段性疲惫或疏离感。`,
            suggestion: '留意自己在哪些场景下消耗最多精力，适当压缩非必要社交，把能量更多投入到真正重要的关系与事务中。',
        },
        'D4': {
            archetype: '多面自我管理型',
            desc: `你的自测（${selfMBTI}）与他测（${peerMBTI}）在多个维度上呈现出明显的反向差异，说明你在不同环境中建立了较为强烈的自我管理机制。你往往会根据外部期待主动调整表达方式、决策逻辑与行为边界，使自己适配各种现实需求。这种高度自控的运作方式有助于短期稳定，但也可能压缩真实感受的表达空间，长期容易形成内在压力积累。`,
            suggestion: '在可信任的关系中尝试降低自我管理强度，允许自己表达真实想法与情绪，为内在状态建立更安全的出口。',
        },
    };

    return conclusions[id];
}

/**
 * 验证邀请码（一码一测）
 * 1. 查询 access_codes 表
 * 2. 不存在 → 无效
 * 3. is_used=true → 已使用
 * 4. 通过 → 核销（is_used=true, used_at=now）
 */
async function verifyAccessCode(code: string): Promise<{ valid: boolean; message?: string; reportId?: string }> {
    try {
        const trimmed = code.trim().toUpperCase();
        if (!trimmed) return { valid: false, message: '请输入邀请码' };

        // 查询
        const { data, error } = await supabase
            .from('access_codes')
            .select('id, is_used, report_id')
            .eq('code', trimmed)
            .single();

        if (error || !data) {
            return { valid: false, message: '无效的邀请码' };
        }

        if (data.is_used) {
            // 已使用但有关联报告 → 返回报告 ID，让前端直接跳转
            if (data.report_id) {
                return { valid: true, reportId: data.report_id };
            }
            return { valid: false, message: '该邀请码已被使用' };
        }

        // 核销
        const { error: updateError } = await supabase
            .from('access_codes')
            .update({ is_used: true, used_at: new Date().toISOString() })
            .eq('id', data.id);

        if (updateError) {
            console.error('[API] 核销邀请码失败:', updateError);
            return { valid: false, message: '系统错误，请稍后再试' };
        }

        return { valid: true };
    } catch (err) {
        console.error('[API] verifyAccessCode 异常:', err);
        return { valid: false, message: '系统错误，请稍后再试' };
    }
}

/**
 * 检查他测是否已完成
 */
async function checkPeerCompleted(reportId: string): Promise<boolean> {
    try {
        const { data, error } = await supabase
            .from('personality_reports')
            .select('content')
            .eq('id', reportId)
            .single();

        if (error || !data) return false;
        return data.content?.perception?.peer_view != null;
    } catch {
        return false;
    }
}

export const api = {
    fetchQuestions,
    fetchPeerQuestions,
    getReport,
    createReport,
    getReportById,
    submitPeerAssessment,
    verifyAccessCode,
    checkPeerCompleted
};

export default api;
